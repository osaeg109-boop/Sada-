<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØµØ¯Ù‰ | Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø´Ø§Ù…Ù„Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6c5ce7;
            --accent: #00cec9;
            --bg: #f0f2f5;
            --text: #2d3436;
            --danger: #ff7675;
        }

        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); padding-bottom: 80px; }

        /* Auth */
        #auth-screen { position: fixed; inset: 0; z-index: 9999; background: var(--primary); display: flex; align-items: center; justify-content: center; padding: 20px; }
        .auth-card { background: white; width: 100%; max-width: 400px; padding: 30px; border-radius: 25px; text-align: center; }
        .inp { width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #eee; border-radius: 12px; outline: none; }
        .btn-main { width: 100%; padding: 14px; border-radius: 12px; border: none; background: var(--primary); color: white; font-weight: bold; cursor: pointer; }

        /* Navigation */
        nav { position: fixed; bottom: 0; width: 100%; background: white; height: 70px; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #999; cursor: pointer; font-size: 11px; font-weight: bold; text-decoration: none; }
        .nav-item.active { color: var(--primary); }

        /* Views */
        .view { display: none; padding: 15px; max-width: 600px; margin: 0 auto; }
        .view.active { display: block; }

        /* Stories */
        .stories-row { display: flex; gap: 12px; overflow-x: auto; padding: 10px 0; scrollbar-width: none; }
        .story-item { flex: 0 0 70px; text-align: center; cursor: pointer; }
        .story-circle { width: 65px; height: 65px; border-radius: 50%; border: 3px solid var(--primary); padding: 2px; }
        .story-circle img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .story-add { border: 2px dashed #ccc; font-size: 24px; display: flex; align-items: center; justify-content: center; color: #999; }

        /* Posts & UI Elements */
        .card { background: white; border-radius: 20px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .avatar { width: 45px; height: 45px; border-radius: 50%; background: #eee; object-fit: cover; }
        .media-box { width: 100%; border-radius: 15px; margin-top: 10px; }

        /* Chat Window */
        #chat-window { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: none; flex-direction: column; }
        #chat-msgs { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg-bubble { max-width: 80%; padding: 10px 15px; border-radius: 18px; font-size: 14px; position: relative; }
        .msg-bubble.me { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .msg-bubble.them { align-self: flex-start; background: white; border-bottom-left-radius: 2px; }

        /* Search List */
        .search-list { max-height: 300px; overflow-y: auto; background: white; border-radius: 15px; margin-bottom: 15px; }
        .user-item { display: flex; align-items: center; gap: 15px; padding: 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- Auth -->
    <div id="auth-screen">
        <div class="auth-card">
            <h1 style="color:var(--primary); margin:0;">ØµØ¯Ù‰</h1>
            <p style="color:#777; margin-bottom:20px;">ØªÙˆØ§ØµÙ„ Ø¨Ø®ØµÙˆØµÙŠØ© ØªØ§Ù…Ø©</p>
            <div id="reg-box">
                <input type="text" id="join-name" class="inp" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
                <input type="text" id="join-user" class="inp" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)">
            </div>
            <input type="email" id="join-email" class="inp" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            <input type="password" id="join-pass" class="inp" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button class="btn-main" onclick="handleAuth()">Ø§Ø³ØªÙ…Ø±Ø§Ø±</button>
            <p onclick="toggleAuth()" style="cursor:pointer; color:var(--primary); font-size:14px; margin-top:15px;">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ</p>
        </div>
    </div>

    <!-- App UI -->
    <header style="background:white; padding:15px; position:sticky; top:0; z-index:1000; display:flex; justify-content:space-between; align-items:center;">
        <div style="font-size:24px; font-weight:900; color:var(--primary);">ØµØ¯Ù‰</div>
        <div onclick="navTo('chat')" style="cursor:pointer; font-size:20px;">âœ‰ï¸</div>
    </header>

    <main>
        <!-- Home View -->
        <div id="home-view" class="view active">
            <div class="stories-row" id="stories-cont">
                <div class="story-item" onclick="document.getElementById('story-file').click()">
                    <div class="story-circle story-add">+</div>
                    <span style="font-size:10px;">Ø£Ø¶Ù Ù‚ØµØ©</span>
                    <input type="file" id="story-file" hidden accept="image/*" onchange="uploadMedia(this, 'stories')">
                </div>
            </div>
            <div id="feed"></div>
        </div>

        <!-- Post View -->
        <div id="post-view" class="view">
            <div class="card">
                <h3>Ù†Ø´Ø± Ø¬Ø¯ÙŠØ¯</h3>
                <textarea id="post-text" class="inp" style="height:120px; resize:none;" placeholder="Ù…Ø§Ø°Ø§ ÙŠØ¯ÙˆØ± ÙÙŠ Ø°Ù‡Ù†ÙƒØŸ"></textarea>
                <input type="file" id="post-file" class="inp" accept="image/*">
                <button class="btn-main" onclick="submitPost()">Ù†Ø´Ø± ÙÙŠ ØµØ¯Ù‰</button>
            </div>
        </div>

        <!-- Chat/Search View -->
        <div id="chat-view" class="view">
            <input type="text" class="inp" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ø§Ø³Ù…..." oninput="searchUsers(this.value)">
            <div id="search-results" class="search-list hidden"></div>
            
            <h4 style="margin:20px 0 10px;">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</h4>
            <div id="threads"></div>
        </div>

        <!-- Profile View -->
        <div id="profile-view" class="view" style="text-align:center;">
            <div class="card">
                <img id="my-pfp" class="avatar" style="width:100px; height:100px; margin-bottom:15px;">
                <h2 id="my-name">...</h2>
                <p id="my-user" style="color:var(--accent);">@...</p>
                <div style="margin:20px 0; border-top:1px solid #eee; padding-top:20px;">
                    <button class="btn-main" style="background:#eee; color:#333; margin-bottom:10px;" onclick="document.getElementById('pfp-file').click()">ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©</button>
                    <input type="file" id="pfp-file" hidden accept="image/*" onchange="updateProfilePic(this)">
                    <button class="btn-main" style="background:var(--danger);" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Chat Pop-up -->
    <div id="chat-window">
        <div style="background:white; padding:15px; border-bottom:1px solid #eee; display:flex; align-items:center; gap:15px;">
            <button onclick="closeChat()" style="border:none; background:none; font-size:22px;">âœ•</button>
            <b id="chat-title">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</b>
        </div>
        <div id="chat-msgs"></div>
        <div style="background:white; padding:15px; display:flex; gap:10px;">
            <button onclick="document.getElementById('chat-img').click()" style="border:none; background:#eee; padding:10px; border-radius:12px;">ğŸ“·</button>
            <input type="file" id="chat-img" hidden accept="image/*" onchange="uploadChatImg(this)">
            <input type="text" id="chat-input" class="inp" style="margin:0;" placeholder="Ø±Ø³Ø§Ù„ØªÙƒ...">
            <button onclick="sendMsg()" style="background:var(--primary); color:white; border:none; width:60px; border-radius:12px;">â¤</button>
        </div>
    </div>

    <!-- Nav -->
    <nav>
        <div class="nav-item active" onclick="navTo('home', this)"><i>ğŸ </i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="nav-item" onclick="navTo('post', this)"><i>â•</i>Ù†Ø´Ø±</div>
        <div class="nav-item" onclick="navTo('chat', this)"><i>ğŸ’¬</i>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</div>
        <div class="nav-item" onclick="navTo('profile', this)"><i>ğŸ‘¤</i>Ø­Ø³Ø§Ø¨ÙŠ</div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, getDoc, setDoc, getDocs, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAhg6oTG1EJ44ST1zkkeYvKpfLMD2JDV3M",
            authDomain: "fir-c3e88.firebaseapp.com",
            projectId: "fir-c3e88",
            storageBucket: "fir-c3e88.firebasestorage.app",
            messagingSenderId: "202130175288",
            appId: "1:202130175288:web:0d7ad99c3c828501b4fdcd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let me = null;
        let isLogin = false;
        let activeChatId = null;

        // --- Utils ---
        const toB64 = (file) => new Promise(res => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = e => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX = 600;
                    let w = img.width, h = img.height;
                    if(w > h) { if(w > MAX) { h *= MAX/w; w = MAX; } }
                    else { if(h > MAX) { w *= MAX/h; h = MAX; } }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    res(canvas.toDataURL('image/jpeg', 0.6));
                }
            }
        });

        // --- Auth ---
        window.toggleAuth = () => {
            isLogin = !isLogin;
            document.getElementById('reg-box').classList.toggle('hidden', isLogin);
        };

        window.handleAuth = async () => {
            const email = document.getElementById('join-email').value;
            const pass = document.getElementById('join-pass').value;
            try {
                if(isLogin) {
                    await signInWithEmailAndPassword(auth, email, pass);
                } else {
                    const name = document.getElementById('join-name').value;
                    const user = document.getElementById('join-user').value.toLowerCase();
                    const res = await createUserWithEmailAndPassword(auth, email, pass);
                    await setDoc(doc(db, "users", res.user.uid), { name, username: user, uid: res.user.uid, pfp: "" });
                }
            } catch(e) { alert(e.message); }
        };

        onAuthStateChanged(auth, async u => {
            if(u) {
                const snap = await getDoc(doc(db, "users", u.uid));
                me = snap.data();
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('my-name').innerText = me.name;
                document.getElementById('my-user').innerText = "@" + me.username;
                document.getElementById('my-pfp').src = me.pfp || "https://ui-avatars.com/api/?name="+me.name;
                initApp();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        });

        // --- Core ---
        function initApp() {
            // Feed
            onSnapshot(collection(db, "posts"), snap => {
                const feed = document.getElementById('feed');
                feed.innerHTML = "";
                let ps = [];
                snap.forEach(d => ps.push(d.data()));
                ps.sort((a,b) => (b.at?.seconds || 0) - (a.at?.seconds || 0));
                ps.forEach(p => {
                    feed.innerHTML += `
                        <div class="card">
                            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                                <img src="${p.pfp || "https://ui-avatars.com/api/?name="+p.author}" class="avatar">
                                <b>${p.author}</b>
                            </div>
                            <div>${p.text}</div>
                            ${p.media ? `<img src="${p.media}" class="media-box">` : ''}
                        </div>
                    `;
                });
            });

            // Stories
            onSnapshot(collection(db, "stories"), snap => {
                const cont = document.getElementById('stories-cont');
                const addBtn = cont.children[0].outerHTML;
                cont.innerHTML = addBtn;
                snap.forEach(d => {
                    const s = d.data();
                    cont.innerHTML += `
                        <div class="story-item">
                            <div class="story-circle"><img src="${s.media}"></div>
                            <span style="font-size:10px;">${s.author}</span>
                        </div>
                    `;
                });
            });
        }

        window.submitPost = async () => {
            const txt = document.getElementById('post-text').value;
            const file = document.getElementById('post-file').files[0];
            let media = file ? await toB64(file) : "";
            await addDoc(collection(db, "posts"), {
                text: txt, media, author: me.name, pfp: me.pfp, uid: me.uid, at: serverTimestamp()
            });
            document.getElementById('post-text').value = "";
            navTo('home', document.querySelectorAll('.nav-item')[0]);
        };

        window.uploadMedia = async (input, type) => {
            if(!input.files[0]) return;
            const b64 = await toB64(input.files[0]);
            await addDoc(collection(db, type), {
                media: b64, author: me.name, uid: me.uid, at: serverTimestamp()
            });
            alert("ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!");
        };

        window.updateProfilePic = async (input) => {
            if(!input.files[0]) return;
            const b64 = await toB64(input.files[0]);
            await updateDoc(doc(db, "users", me.uid), { pfp: b64 });
            me.pfp = b64;
            document.getElementById('my-pfp').src = b64;
        };

        // --- Search & Messaging ---
        window.searchUsers = async (val) => {
            const resDiv = document.getElementById('search-results');
            if(val.length < 2) { resDiv.classList.add('hidden'); return; }
            const q = query(collection(db, "users"));
            const snap = await getDocs(q);
            resDiv.innerHTML = "";
            resDiv.classList.remove('hidden');
            snap.forEach(d => {
                const u = d.data();
                if(u.uid !== me.uid && u.name.toLowerCase().includes(val.toLowerCase())) {
                    resDiv.innerHTML += `
                        <div class="user-item" onclick="openChat('${u.uid}', '${u.name}')">
                            <img src="${u.pfp || "https://ui-avatars.com/api/?name="+u.name}" class="avatar">
                            <div><b>${u.name}</b><br><small>@${u.username}</small></div>
                        </div>
                    `;
                }
            });
        };

        window.openChat = (uid, name) => {
            activeChatId = uid;
            document.getElementById('chat-title').innerText = name;
            document.getElementById('chat-window').style.display = 'flex';
            const cid = [me.uid, uid].sort().join("_");
            onSnapshot(query(collection(db, "messages"), where("cid", "==", cid)), snap => {
                const box = document.getElementById('chat-msgs');
                box.innerHTML = "";
                let msgs = [];
                snap.forEach(d => msgs.push(d.data()));
                msgs.sort((a,b) => (a.at?.seconds || 0) - (b.at?.seconds || 0));
                msgs.forEach(m => {
                    box.innerHTML += `
                        <div class="msg-bubble ${m.from === me.uid ? 'me' : 'them'}">
                            ${m.text ? `<div>${m.text}</div>` : ''}
                            ${m.media ? `<img src="${m.media}" class="media-box">` : ''}
                        </div>
                    `;
                });
                box.scrollTop = box.scrollHeight;
            });
        };

        window.sendMsg = async () => {
            const inp = document.getElementById('chat-input');
            if(!inp.value) return;
            const cid = [me.uid, activeChatId].sort().join("_");
            await addDoc(collection(db, "messages"), {
                cid, text: inp.value, from: me.uid, at: serverTimestamp()
            });
            inp.value = "";
        };

        window.uploadChatImg = async (input) => {
            if(!input.files[0]) return;
            const b64 = await toB64(input.files[0]);
            const cid = [me.uid, activeChatId].sort().join("_");
            await addDoc(collection(db, "messages"), {
                cid, media: b64, from: me.uid, at: serverTimestamp()
            });
        };

        window.closeChat = () => document.getElementById('chat-window').style.display = 'none';

        window.navTo = (id, el) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id + '-view').classList.add('active');
            if(el) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                el.classList.add('active');
            }
            if(id === 'chat') renderThreads();
        };

        async function renderThreads() {
            const list = document.getElementById('threads');
            list.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
            const snap = await getDocs(collection(db, "messages"));
            const uids = new Set();
            snap.forEach(d => {
                const m = d.data();
                const cidParts = m.cid.split("_");
                uids.add(cidParts[0] === me.uid ? cidParts[1] : cidParts[0]);
            });
            list.innerHTML = uids.size ? "" : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª.";
            for(let id of uids) {
                const u = (await getDoc(doc(db, "users", id))).data();
                if(u) {
                    list.innerHTML += `
                        <div class="user-item" onclick="openChat('${u.uid}', '${u.name}')">
                            <img src="${u.pfp || "https://ui-avatars.com/api/?name="+u.name}" class="avatar">
                            <div><b>${u.name}</b><br><small>Ù…Ø­Ø§Ø¯Ø«Ø© Ù†Ø´Ø·Ø©</small></div>
                        </div>
                    `;
                }
            }
        }

        window.logout = () => signOut(auth).then(() => location.reload());
    </script>
</body>
</html>

