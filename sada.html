<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØµØ¯Ù‰ | Sada Global</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #5f27cd;
            --secondary: #00d2d3;
            --bg: #f7f8fa;
            --card: #ffffff;
            --text-main: #2d3436;
            --text-sub: #636e72;
            --accent: #ff9f43;
            --danger: #ee5253;
            --glass: rgba(255, 255, 255, 0.9);
        }

        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text-main); padding-bottom: 80px; overflow-x: hidden; }

        /* --- Auth Layer --- */
        #auth-overlay { 
            position: fixed; inset: 0; z-index: 10000; 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .auth-container { 
            background: var(--card); width: 100%; max-width: 450px; padding: 35px; 
            border-radius: 30px; box-shadow: 0 30px 60px rgba(0,0,0,0.3); text-align: center;
        }
        .auth-logo { font-size: 50px; font-weight: 900; color: var(--primary); margin-bottom: 10px; }
        .inp-field { width: 100%; padding: 14px; margin-bottom: 12px; border: 2px solid #edf2f7; border-radius: 15px; font-size: 16px; transition: 0.3s; }
        .inp-field:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 10px rgba(95, 39, 205, 0.1); }
        .btn-auth { width: 100%; padding: 16px; border-radius: 15px; border: none; background: var(--primary); color: white; font-weight: 800; font-size: 18px; cursor: pointer; transition: 0.3s; }
        .btn-auth:active { transform: scale(0.98); }

        /* --- Global Header --- */
        header { 
            background: var(--glass); backdrop-filter: blur(15px);
            padding: 15px 25px; position: sticky; top: 0; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .app-name { font-size: 26px; font-weight: 900; color: var(--primary); letter-spacing: -1px; }

        /* --- Content Layout --- */
        .view { display: none; padding: 20px; max-width: 650px; margin: 0 auto; animation: slideIn 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        .view.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Stories Section --- */
        .story-container { display: flex; gap: 15px; overflow-x: auto; padding: 10px 5px; scrollbar-width: none; }
        .story-node { flex-shrink: 0; text-align: center; width: 75px; }
        .story-circle { 
            width: 70px; height: 70px; border-radius: 50%; padding: 3px; 
            background: linear-gradient(45deg, #feca57, #ff9f43, #ee5253, #f368e0, #5f27cd);
            cursor: pointer; position: relative;
        }
        .story-circle.plus { background: #dfe6e9; display: flex; align-items: center; justify-content: center; font-size: 30px; font-weight: bold; color: #b2bec3; }
        .story-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid #fff; }

        /* --- Post Component --- */
        .post { background: var(--card); border-radius: 25px; padding: 20px; margin-bottom: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.02); }
        .post-header { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
        .pfp-main { width: 50px; height: 50px; border-radius: 18px; object-fit: cover; background: #eee; }
        .post-info b { display: block; font-size: 16px; }
        .post-info span { color: var(--text-sub); font-size: 13px; font-weight: 600; }
        .post-text { font-size: 16px; line-height: 1.6; margin: 10px 0; color: #444; }
        .post-media { width: 100%; border-radius: 20px; margin-top: 10px; max-height: 500px; object-fit: cover; }
        .post-actions { display: flex; gap: 15px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #f1f2f6; }
        .action-item { flex: 1; padding: 10px; border-radius: 12px; border: none; background: #f8f9fa; color: var(--text-sub); font-weight: 700; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: 0.2s; }
        .action-item.liked { color: var(--danger); background: #fff1f1; }

        /* --- Chat List Update --- */
        .chat-thread-item { 
            display: flex; align-items: center; gap: 15px; padding: 15px; 
            background: white; border-radius: 20px; margin-bottom: 10px; 
            cursor: pointer; transition: 0.2s; border: 1px solid transparent;
        }
        .chat-thread-item:hover { border-color: var(--primary); background: #fdfcff; }
        
        #private-chat-win { position: fixed; inset: 0; background: var(--bg); z-index: 5000; display: flex; flex-direction: column; }
        .chat-header { background: white; padding: 15px 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #eee; }
        #messages-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .bubble { max-width: 80%; padding: 12px 16px; border-radius: 20px; font-size: 14px; line-height: 1.5; }
        .bubble.me { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .bubble.them { align-self: flex-start; background: white; color: var(--text-main); border-bottom-left-radius: 4px; border: 1px solid #eee; }

        /* --- Navigation --- */
        nav { position: fixed; bottom: 0; width: 100%; background: var(--card); height: 80px; display: flex; align-items: center; justify-content: space-around; border-top: 1px solid #eee; z-index: 1000; }
        .nav-btn { display: flex; flex-direction: column; align-items: center; color: #b2bec3; cursor: pointer; transition: 0.3s; }
        .nav-btn.active { color: var(--primary); }
        .nav-btn i { font-size: 26px; }
        .nav-btn span { font-size: 11px; font-weight: 800; margin-top: 4px; }

        .hidden { display: none !important; }
        #upload-preview { width: 100%; border-radius: 15px; display: none; margin-top: 15px; }
    </style>
</head>
<body>

    <!-- Auth Module -->
    <div id="auth-overlay">
        <div class="auth-container">
            <div class="auth-logo">ØµØ¯Ù‰</div>
            <p id="auth-desc" style="font-weight: 500; color: #636e72; margin-bottom: 30px;">ØªÙˆØ§ØµÙ„ Ø¨Ø®ØµÙˆØµÙŠØ© ØªØ§Ù…Ø© ÙˆØ¥Ø¨Ø¯Ø§Ø¹ Ù„Ø§ ÙŠÙ†ØªÙ‡ÙŠ</p>
            <div id="auth-error" style="color:var(--danger); font-size: 13px; margin-bottom: 15px;"></div>
            
            <div id="reg-fields">
                <input type="text" id="reg-name" class="inp-field" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
                <input type="text" id="reg-user" class="inp-field" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ø«Ø§Ù„: ali_99)">
                <div style="text-align: right; margin-bottom: 15px;">
                    <label style="font-size: 12px; font-weight: 700; color: var(--text-sub);">ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ:</label>
                    <input type="file" id="reg-pfp-file" accept="image/*" class="inp-field" style="font-size: 12px; padding: 8px;">
                </div>
            </div>

            <input type="email" id="auth-email" class="inp-field" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            <input type="password" id="auth-pass" class="inp-field" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            
            <button class="btn-auth" id="auth-submit-btn" onclick="handleAuthentication()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
            <p style="margin-top: 25px; font-size: 14px;">
                <span id="toggle-hint">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ</span>
                <a href="javascript:void(0)" onclick="toggleAuth()" id="toggle-link" style="color: var(--primary); font-weight: 900; text-decoration: none;">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ</a>
            </p>
        </div>
    </div>

    <!-- Main Application Header -->
    <header id="main-header" class="hidden">
        <div class="app-name">ØµØ¯Ù‰</div>
        <div style="display: flex; gap: 20px;">
            <span onclick="navTo('chat')" style="cursor:pointer; font-size: 22px;">ğŸ’¬</span>
            <span onclick="navTo('search')" style="cursor:pointer; font-size: 22px;">ğŸ”</span>
        </div>
    </header>

    <div id="main-app" class="hidden">
        
        <!-- Home View -->
        <div id="home-view" class="view active">
            <div class="story-container" id="story-list">
                <div class="story-node" onclick="document.getElementById('story-file').click()">
                    <div class="story-circle plus">+</div>
                    <div style="font-size: 11px; margin-top: 5px; font-weight: 800;">Ù‚ØµØªÙƒ</div>
                    <input type="file" id="story-file" hidden accept="image/*" onchange="uploadStory(this)">
                </div>
            </div>
            <div id="feed-container"></div>
        </div>

        <!-- Search View -->
        <div id="search-view" class="view">
            <input type="text" id="search-box" class="inp-field" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ØµØ¯Ù‚Ø§Ø¡..." oninput="executeSearch()">
            <div id="search-results"></div>
        </div>

        <!-- Post Creation View -->
        <div id="post-view" class="view">
            <div class="post">
                <h3 style="margin: 0 0 15px 0;">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø´ÙˆØ±</h3>
                <textarea id="post-caption" style="width:100%; height:150px; border:none; background:#f9f9f9; border-radius:20px; padding:20px; font-size:16px; outline:none; resize:none;" placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙØ§Ù‹ Ù„Ù…Ù†Ø´ÙˆØ±Ùƒ..."></textarea>
                <div style="border: 2px dashed #ddd; border-radius: 20px; padding: 30px; text-align: center; cursor: pointer; margin-top: 15px;" onclick="document.getElementById('post-media-file').click()">
                    <span style="font-weight: 700; color: var(--text-sub);">ğŸ“¸ Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ØµÙˆØ±Ø©</span>
                    <input type="file" id="post-media-file" hidden accept="image/*" onchange="previewPostMedia(this)">
                    <img id="upload-preview">
                </div>
                <button class="btn-auth" style="margin-top: 20px;" onclick="submitPost()">Ù†Ø´Ø± ÙÙŠ ØµØ¯Ù‰</button>
            </div>
        </div>

        <!-- Chat Management View (MODIFIED) -->
        <div id="chat-view" class="view">
            <h2 style="margin-bottom: 20px;">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h2>
            <div id="chat-threads-container">
                <!-- Threads will be loaded here -->
            </div>

            <!-- Messaging Window -->
            <div id="private-chat-win" class="hidden">
                <div class="chat-header">
                    <button onclick="closeChatWindow()" style="border:none; background:none; font-size:24px;">â†</button>
                    <img id="chat-header-img" class="pfp-main" style="width:40px; height:40px;">
                    <b id="chat-header-name">...</b>
                </div>
                <div id="messages-container"></div>
                <div style="padding: 15px; background: white; display: flex; gap: 10px;">
                    <input type="text" id="chat-input" class="inp-field" style="margin:0;" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
                    <button onclick="sendMessage()" style="background:var(--primary); color:white; border:none; width:50px; border-radius:15px; font-size:20px;">â¤</button>
                </div>
            </div>
        </div>

        <!-- Profile View -->
        <div id="profile-view" class="view">
            <div class="post" style="text-align: center; padding: 40px 20px;">
                <img id="my-pfp" class="pfp-main" style="width: 110px; height: 110px; border-radius: 35px; border: 4px solid var(--primary); margin-bottom: 15px;">
                <h2 id="my-name" style="margin:0;">...</h2>
                <p id="my-user" style="color: var(--secondary); font-weight: 800; margin: 5px 0 25px 0;">@username</p>
                
                <div style="display: flex; justify-content: center; gap: 30px; margin-bottom: 30px;">
                    <div><b id="my-followers" style="font-size: 20px;">0</b><br><small style="color:var(--text-sub)">Ù…ØªØ§Ø¨Ø¹</small></div>
                    <div><b id="my-following" style="font-size: 20px;">0</b><br><small style="color:var(--text-sub)">Ù…ØªØ§Ø¨Ø¹Ø©</small></div>
                </div>

                <button class="btn-auth" style="background: var(--danger); box-shadow: 0 10px 20px rgba(238, 82, 83, 0.2);" onclick="handleLogout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

    </div>

    <!-- Navigation Bar -->
    <nav id="bottom-nav" class="hidden">
        <div class="nav-btn active" onclick="navTo('home', this)"><i>ğŸ </i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
        <div class="nav-btn" onclick="navTo('search', this)"><i>ğŸ”</i><span>Ø§ÙƒØªØ´Ù</span></div>
        <div class="nav-btn" onclick="navTo('post', this)"><i>â•</i><span>Ù†Ø´Ø±</span></div>
        <div class="nav-btn" onclick="navTo('chat', this)"><i>ğŸ’¬</i><span>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</span></div>
        <div class="nav-btn" onclick="navTo('profile', this)"><i>ğŸ‘¤</i><span>Ø­Ø³Ø§Ø¨ÙŠ</span></div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, serverTimestamp, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAhg6oTG1EJ44ST1zkkeYvKpfLMD2JDV3M",
            authDomain: "fir-c3e88.firebaseapp.com",
            projectId: "fir-c3e88",
            storageBucket: "fir-c3e88.firebasestorage.app",
            messagingSenderId: "202130175288",
            appId: "1:202130175288:web:0d7ad99c3c828501b4fdcd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let myData = null, isReg = true, activeImage = null, chatTarget = null, msgUnsubscribe = null;

        // --- Helper: Image Processing ---
        const processImage = (file) => new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_SIZE = 700;
                    let w = img.width, h = img.height;
                    if(w > h) { if(w > MAX_SIZE) { h *= MAX_SIZE/w; w = MAX_SIZE; } }
                    else { if(h > MAX_SIZE) { w *= MAX_SIZE/h; h = MAX_SIZE; } }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
            };
        });

        // --- Authentication Logic ---
        window.toggleAuth = () => {
            isReg = !isReg;
            document.getElementById('reg-fields').classList.toggle('hidden');
            document.getElementById('auth-submit-btn').innerText = isReg ? "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨" : "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
            document.getElementById('toggle-hint').innerText = isReg ? "Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ" : "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ";
            document.getElementById('toggle-link').innerText = isReg ? "Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ" : "Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù†";
        };

        window.handleAuthentication = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const err = document.getElementById('auth-error');
            err.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±...";

            try {
                if(isReg) {
                    const name = document.getElementById('reg-name').value;
                    const username = document.getElementById('reg-user').value.toLowerCase().trim();
                    const pfpFile = document.getElementById('reg-pfp-file').files[0];
                    if(!name || !username) throw new Error("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

                    const checkQ = query(collection(db, "users"), where("username", "==", username));
                    const checkSnap = await getDocs(checkQ);
                    if(!checkSnap.empty) throw new Error("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø£Ø®ÙˆØ° Ù…Ø³Ø¨Ù‚Ø§Ù‹");

                    let pfpData = "";
                    if(pfpFile) pfpData = await processImage(pfpFile);

                    const res = await createUserWithEmailAndPassword(auth, email, pass);
                    await setDoc(doc(db, "users", res.user.uid), {
                        name, username, pfp: pfpData, uid: res.user.uid, followers: [], following: []
                    });
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch(e) { err.innerText = e.message; }
        };

        onAuthStateChanged(auth, async (user) => {
            if(user) {
                document.getElementById('auth-overlay').classList.add('hidden');
                document.getElementById('main-header').classList.remove('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('bottom-nav').classList.remove('hidden');
                
                const snap = await getDoc(doc(db, "users", user.uid));
                myData = snap.data();
                
                document.getElementById('my-name').innerText = myData.name;
                document.getElementById('my-user').innerText = "@" + myData.username;
                document.getElementById('my-pfp').src = myData.pfp || 'https://via.placeholder.com/110';
                document.getElementById('my-followers').innerText = myData.followers?.length || 0;
                document.getElementById('my-following').innerText = myData.following?.length || 0;
                
                loadFeed();
                loadStories();
                loadChatThreads(); // Initial load of conversations
            }
        });

        window.handleLogout = () => signOut(auth).then(() => location.reload());

        // --- Core Navigation ---
        window.navTo = (viewId, el) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId + '-view').classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(el) el.classList.add('active');
            if(viewId === 'chat') loadChatThreads();
        };

        // --- Feed & Posts ---
        window.previewPostMedia = async (inp) => {
            if(inp.files[0]) {
                activeImage = await processImage(inp.files[0]);
                const pre = document.getElementById('upload-preview');
                pre.src = activeImage;
                pre.style.display = 'block';
            }
        };

        window.submitPost = async () => {
            const txt = document.getElementById('post-caption').value;
            if(!txt && !activeImage) return;
            await addDoc(collection(db, "posts"), {
                text: txt, media: activeImage || "", author: myData.name, 
                username: myData.username, authorPfp: myData.pfp || "", 
                uid: auth.currentUser.uid, likes: [], at: serverTimestamp()
            });
            document.getElementById('post-caption').value = "";
            document.getElementById('upload-preview').style.display = 'none';
            activeImage = null;
            navTo('home', document.querySelectorAll('.nav-btn')[0]);
        };

        function loadFeed() {
            const q = query(collection(db, "posts"), orderBy("at", "desc"));
            onSnapshot(q, (snap) => {
                const container = document.getElementById('feed-container');
                container.innerHTML = "";
                snap.forEach(d => {
                    const p = d.data();
                    const isLiked = p.likes?.includes(auth.currentUser.uid);
                    container.innerHTML += `
                        <div class="post">
                            <div class="post-header">
                                <img src="${p.authorPfp || 'https://via.placeholder.com/50'}" class="pfp-main">
                                <div class="post-info">
                                    <b>${p.author}</b>
                                    <span>@${p.username}</span>
                                </div>
                                ${p.uid !== auth.currentUser.uid ? `<button onclick="toggleFollow('${p.uid}')" style="margin-right:auto; color:var(--primary); font-weight:900; border:none; background:none;">Ù…ØªØ§Ø¨Ø¹Ø©</button>` : ''}
                            </div>
                            <div class="post-text">${p.text}</div>
                            ${p.media ? `<img src="${p.media}" class="post-media">` : ''}
                            <div class="post-actions">
                                <button class="action-item ${isLiked ? 'liked' : ''}" onclick="handleLike('${d.id}', ${isLiked})">
                                    ${isLiked ? 'â¤ï¸' : 'ğŸ¤'} ${p.likes?.length || 0}
                                </button>
                                <button class="action-item" onclick="openMessaging('${p.uid}', '${p.author}', '${p.authorPfp}')">ğŸ’¬ Ù…Ø±Ø§Ø³Ù„Ø©</button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        window.handleLike = async (id, liked) => {
            await updateDoc(doc(db, "posts", id), { likes: liked ? arrayRemove(auth.currentUser.uid) : arrayUnion(auth.currentUser.uid) });
        };

        window.toggleFollow = async (tid) => {
            await updateDoc(doc(db, "users", auth.currentUser.uid), { following: arrayUnion(tid) });
            await updateDoc(doc(db, "users", tid), { followers: arrayUnion(auth.currentUser.uid) });
        };

        // --- Stories ---
        window.uploadStory = async (f) => {
            if(f.files[0]) {
                const sData = await processImage(f.files[0]);
                await addDoc(collection(db, "stories"), {
                    media: sData, author: myData.name, at: serverTimestamp()
                });
            }
        };

        function loadStories() {
            const q = query(collection(db, "stories"), orderBy("at", "desc"));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('story-list');
                const existing = list.querySelectorAll('.story-node:not(:first-child)');
                existing.forEach(e => e.remove());
                snap.forEach(d => {
                    const s = d.data();
                    list.innerHTML += `
                        <div class="story-node" onclick="alert('Ù…Ø´Ø§Ù‡Ø¯Ø© Ù‚ØµØ© ${s.author}')">
                            <div class="story-circle"><img src="${s.media}" class="story-img"></div>
                            <div style="font-size: 11px; margin-top: 5px; font-weight: 800;">${s.author}</div>
                        </div>
                    `;
                });
            });
        }

        // --- NEW Messaging Logic (MODIFIED) ---

        // Function to load all people you have chatted with
        async function loadChatThreads() {
            const container = document.getElementById('chat-threads-container');
            container.innerHTML = "<p style='text-align:center; color:#999;'>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª...</p>";

            // 1. Get all messages where I am sender or receiver
            const q1 = query(collection(db, "messages"), where("from", "==", auth.currentUser.uid));
            const q2 = query(collection(db, "messages"), where("to", "==", auth.currentUser.uid));

            const [s1, s2] = await Promise.all([getDocs(q1), getDocs(q2)]);
            
            const talkedToUids = new Set();
            s1.forEach(d => talkedToUids.add(d.data().to));
            s2.forEach(d => talkedToUids.add(d.data().from));

            if(talkedToUids.size === 0) {
                container.innerHTML = "<p style='text-align:center; color:#999; margin-top:50px;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø³Ø§Ø¨Ù‚Ø©.<br>Ø§Ø¨Ø¯Ø£ Ø¨Ù…Ø±Ø§Ø³Ù„Ø© Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©!</p>";
                return;
            }

            // 2. Fetch User Details for each UID
            container.innerHTML = "";
            for (let uid of talkedToUids) {
                const userSnap = await getDoc(doc(db, "users", uid));
                if(userSnap.exists()) {
                    const u = userSnap.data();
                    const item = document.createElement('div');
                    item.className = "chat-thread-item";
                    item.innerHTML = `
                        <img src="${u.pfp || 'https://via.placeholder.com/50'}" class="pfp-main">
                        <div>
                            <b style="font-size:16px;">${u.name}</b><br>
                            <span style="color:var(--text-sub); font-size:12px;">@${u.username}</span>
                        </div>
                        <i style="margin-right:auto; color:var(--primary); font-size:20px;">ğŸ’¬</i>
                    `;
                    item.onclick = () => openMessaging(u.uid, u.name, u.pfp);
                    container.appendChild(item);
                }
            }
        }

        window.openMessaging = (uid, name, pfp) => {
            if(uid === auth.currentUser.uid) return;
            chatTarget = { uid, name, pfp };
            document.getElementById('chat-header-name').innerText = name;
            document.getElementById('chat-header-img').src = pfp || 'https://via.placeholder.com/50';
            document.getElementById('private-chat-win').classList.remove('hidden');
            loadMessages(uid);
        };

        window.closeChatWindow = () => {
            document.getElementById('private-chat-win').classList.add('hidden');
            if(msgUnsubscribe) msgUnsubscribe();
            loadChatThreads(); // Refresh threads list
        };

        window.sendMessage = async () => {
            const txt = document.getElementById('chat-input').value;
            if(!txt.trim()) return;
            const conversationId = [auth.currentUser.uid, chatTarget.uid].sort().join('_');
            await addDoc(collection(db, "messages"), {
                conversationId, text: txt, from: auth.currentUser.uid, to: chatTarget.uid, at: serverTimestamp()
            });
            document.getElementById('chat-input').value = "";
        };

        function loadMessages(targetUid) {
            if(msgUnsubscribe) msgUnsubscribe();
            const conversationId = [auth.currentUser.uid, targetUid].sort().join('_');
            const q = query(collection(db, "messages"), where("conversationId", "==", conversationId), orderBy("at", "asc"));
            msgUnsubscribe = onSnapshot(q, (snap) => {
                const container = document.getElementById('messages-container');
                container.innerHTML = "";
                snap.forEach(d => {
                    const m = d.data();
                    const isMe = m.from === auth.currentUser.uid;
                    container.innerHTML += `<div class="bubble ${isMe ? 'me' : 'them'}">${m.text}</div>`;
                });
                container.scrollTop = container.scrollHeight;
            });
        }

        // --- Search Functionality ---
        window.executeSearch = async () => {
            const queryText = document.getElementById('search-box').value.toLowerCase();
            const results = document.getElementById('search-results');
            if(!queryText) { results.innerHTML = ""; return; }

            const snap = await getDocs(collection(db, "users"));
            results.innerHTML = "";
            snap.forEach(d => {
                const u = d.data();
                if(u.username.includes(queryText) && u.uid !== auth.currentUser.uid) {
                    results.innerHTML += `
                        <div class="chat-thread-item" onclick="openMessaging('${u.uid}', '${u.name}', '${u.pfp}')">
                            <img src="${u.pfp || 'https://via.placeholder.com/50'}" class="pfp-main">
                            <div>
                                <b style="font-size:16px;">${u.name}</b><br>
                                <span style="color:var(--secondary);">@${u.username}</span>
                            </div>
                        </div>
                    `;
                }
            });
        };

    </script>
</body>
</html>

