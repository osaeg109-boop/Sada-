<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØµØ¯Ù‰ | Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6c5ce7;
            --accent: #00cec9;
            --bg: #f8f9fa;
            --card: #ffffff;
            --text: #2d3436;
            --light: #636e72;
            --danger: #ff7675;
        }

        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); padding-bottom: 80px; }

        /* Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        #auth-screen { position: fixed; inset: 0; z-index: 9999; background: var(--primary); display: flex; align-items: center; justify-content: center; padding: 20px; }
        .auth-card { background: white; width: 100%; max-width: 400px; padding: 30px; border-radius: 25px; text-align: center; }
        .inp { width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #eee; border-radius: 12px; outline: none; transition: 0.3s; }
        .inp:focus { border-color: var(--primary); }
        .btn { padding: 12px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-main { background: var(--primary); color: white; width: 100%; }
        .btn-main:active { transform: scale(0.98); }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„ØªÙ†Ù‚Ù„ */
        header { background: white; padding: 15px 20px; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        nav { position: fixed; bottom: 0; width: 100%; background: white; height: 70px; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #999; font-size: 11px; cursor: pointer; }
        .nav-item.active { color: var(--primary); }

        /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
        .view { display: none; padding: 15px; max-width: 600px; margin: 0 auto; animation: fadeIn 0.3s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Ø§Ù„Ù‚ØµØµ ÙˆØ§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª */
        .stories-row { display: flex; gap: 12px; overflow-x: auto; padding: 10px 0; scrollbar-width: none; }
        .story { flex: 0 0 70px; text-align: center; cursor: pointer; }
        .story-ring { width: 65px; height: 65px; border-radius: 50%; border: 3px solid var(--primary); padding: 2px; }
        .story-ring img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        
        .post { background: white; border-radius: 20px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); position: relative; }
        .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; cursor: pointer; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; background: #eee; }
        .post-img { width: 100%; border-radius: 15px; margin: 10px 0; }
        .post-actions { display: flex; gap: 15px; margin-top: 10px; border-top: 1px solid #f9f9f9; padding-top: 10px; }
        .action-btn { background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 5px; color: var(--light); font-size: 14px; }
        .delete-btn { position: absolute; top: 15px; left: 15px; color: var(--danger); font-size: 12px; cursor: pointer; }

        /* Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ */
        .profile-header { text-align: center; padding: 20px; background: white; border-radius: 25px; margin-bottom: 20px; }
        .stats { display: flex; justify-content: center; gap: 30px; margin: 15px 0; }
        .stat-box { text-align: center; }
        .stat-num { display: block; font-weight: 900; font-size: 18px; }
        .stat-label { font-size: 12px; color: var(--light); }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© */
        #chat-ui { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: none; flex-direction: column; }
        #chat-msgs { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .bubble { max-width: 75%; padding: 10px 15px; border-radius: 18px; font-size: 14px; }
        .bubble.me { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .bubble.them { align-self: flex-start; background: white; border-bottom-left-radius: 2px; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="auth-screen">
        <div class="auth-card">
            <h1 style="color:var(--primary); margin:0 0 20px;">ØµØ¯Ù‰</h1>
            <div id="reg-fields">
                <input type="text" id="auth-name" class="inp" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
                <input type="text" id="auth-user" class="inp" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)">
            </div>
            <input type="email" id="auth-email" class="inp" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            <input type="password" id="auth-pass" class="inp" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button class="btn btn-main" onclick="processAuth()">Ø§Ø³ØªÙ…Ø±Ø§Ø±</button>
            <p onclick="toggleAuthMode()" id="auth-toggle" style="margin-top:15px; font-size:13px; color:var(--primary); cursor:pointer;">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ</p>
        </div>
    </div>

    <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
    <header id="app-header" class="hidden">
        <div style="font-size:22px; font-weight:900; color:var(--primary);">ØµØ¯Ù‰</div>
        <div style="display:flex; gap:15px;">
            <span onclick="navTo('chat')" style="cursor:pointer;">âœ‰ï¸</span>
        </div>
    </header>

    <main id="app-content" class="hidden">
        
        <!-- Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <div id="home-view" class="view active">
            <div class="stories-row" id="stories-list">
                <div class="story" onclick="document.getElementById('story-inp').click()">
                    <div class="story-ring" style="border-style:dashed; display:flex; align-items:center; justify-content:center; color:#ccc; font-size:30px;">+</div>
                    <input type="file" id="story-inp" hidden accept="image/*" onchange="uploadMedia(this, 'stories')">
                </div>
            </div>
            <div id="feed"></div>
        </div>

        <!-- Ø§Ù„Ø¨Ø­Ø« -->
        <div id="search-view" class="view">
            <input type="text" class="inp" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ØµØ¯Ù‚Ø§Ø¡..." oninput="globalSearch(this.value)">
            <div id="search-results" style="margin-top:15px;"></div>
        </div>

        <!-- Ø§Ù„Ù†Ø´Ø± -->
        <div id="post-view" class="view">
            <div class="post">
                <h3>Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯</h3>
                <textarea id="post-text" class="inp" style="height:100px; resize:none;" placeholder="Ù…Ø§Ø°Ø§ ÙŠØ¯ÙˆØ± ÙÙŠ Ø°Ù‡Ù†ÙƒØŸ"></textarea>
                <input type="file" id="post-file" class="inp" accept="image/*">
                <button class="btn btn-main" onclick="createPost()">Ù†Ø´Ø± Ø§Ù„Ø¢Ù†</button>
            </div>
        </div>

        <!-- Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ (Ù„ÙŠ Ø£Ùˆ Ù„Ù„Ø¢Ø®Ø±ÙŠÙ†) -->
        <div id="profile-view" class="view">
            <div class="profile-header">
                <img id="prof-pfp" class="avatar" style="width:90px; height:90px; margin-bottom:10px; border:3px solid var(--primary);">
                <h2 id="prof-name" style="margin:0;">...</h2>
                <p id="prof-user" style="color:var(--light); font-size:14px;">@...</p>
                <div class="stats">
                    <div class="stat-box"><span class="stat-num" id="stat-posts">0</span><span class="stat-label">Ù…Ù†Ø´ÙˆØ±</span></div>
                    <div class="stat-box"><span class="stat-num" id="stat-followers">0</span><span class="stat-label">Ù…ØªØ§Ø¨Ø¹</span></div>
                </div>
                <div id="prof-actions">
                    <!-- ØªØ¸Ù‡Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ (ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ù…ØªØ§Ø¨Ø¹Ø©/Ù…Ø±Ø§Ø³Ù„Ø©) -->
                </div>
            </div>
            <div id="prof-posts"></div>
        </div>

        <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
        <div id="chat-view" class="view">
            <h4>Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©</h4>
            <div id="threads-list"></div>
        </div>

    </main>

    <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Pop-up -->
    <div id="chat-ui">
        <div style="background:white; padding:15px; border-bottom:1px solid #eee; display:flex; align-items:center; gap:15px;">
            <button onclick="closeChat()" style="border:none; background:none; font-size:22px;">âœ•</button>
            <b id="chat-target-name">...</b>
        </div>
        <div id="chat-msgs"></div>
        <div style="background:white; padding:15px; display:flex; gap:10px;">
            <button onclick="document.getElementById('chat-img').click()" style="border:none; background:#eee; padding:10px; border-radius:10px;">ğŸ“·</button>
            <input type="file" id="chat-img" hidden accept="image/*" onchange="uploadChatImg(this)">
            <input type="text" id="chat-input" class="inp" style="margin:0;" placeholder="Ø§ÙƒØªØ¨ Ø´ÙŠØ¦Ø§Ù‹...">
            <button onclick="sendMsg()" style="background:var(--primary); color:white; border:none; padding:0 15px; border-radius:10px;">â¤</button>
        </div>
    </div>

    <!-- Ø§Ù„Ù†Ø§ÙØ¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ -->
    <nav id="app-nav" class="hidden">
        <div class="nav-item active" onclick="navTo('home', this)"><i>ğŸ </i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
        <div class="nav-item" onclick="navTo('search', this)"><i>ğŸ”</i><span>Ø§Ø³ØªÙƒØ´Ø§Ù</span></div>
        <div class="nav-item" onclick="navTo('post', this)"><i>â•</i><span>Ù†Ø´Ø±</span></div>
        <div class="nav-item" onclick="viewProfile()"><i>ğŸ‘¤</i><span>Ø­Ø³Ø§Ø¨ÙŠ</span></div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, getDoc, setDoc, getDocs, serverTimestamp, updateDoc, deleteDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAhg6oTG1EJ44ST1zkkeYvKpfLMD2JDV3M",
            authDomain: "fir-c3e88.firebaseapp.com",
            projectId: "fir-c3e88",
            storageBucket: "fir-c3e88.firebasestorage.app",
            messagingSenderId: "202130175288",
            appId: "1:202130175288:web:0d7ad99c3c828501b4fdcd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let me = null;
        let isLoginMode = false;
        let activeChatUid = null;

        // --- Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØµÙˆØ± ---
        const toB64 = (file) => new Promise(res => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = e => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX = 600;
                    let w = img.width, h = img.height;
                    if(w > h) { if(w > MAX) { h *= MAX/w; w = MAX; } }
                    else { if(h > MAX) { w *= MAX/h; h = MAX; } }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    res(canvas.toDataURL('image/jpeg', 0.6));
                }
            }
        });

        // --- Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ---
        window.toggleAuthMode = () => {
            isLoginMode = !isLoginMode;
            document.getElementById('reg-fields').classList.toggle('hidden', isLoginMode);
            document.getElementById('auth-toggle').innerText = isLoginMode ? "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø§Ø´ØªØ±Ùƒ" : "Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ";
        };

        window.processAuth = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            try {
                if(isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, pass);
                } else {
                    const name = document.getElementById('auth-name').value;
                    const user = document.getElementById('auth-user').value.toLowerCase();
                    const res = await createUserWithEmailAndPassword(auth, email, pass);
                    await setDoc(doc(db, "users", res.user.uid), { 
                        name, username: user, uid: res.user.uid, pfp: "", 
                        followers: [], following: [], isPublic: true 
                    });
                }
            } catch(e) { alert("Ø®Ø·Ø£: " + e.message); }
        };

        onAuthStateChanged(auth, async u => {
            if(u) {
                const snap = await getDoc(doc(db, "users", u.uid));
                me = snap.data();
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-header').classList.remove('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                document.getElementById('app-nav').classList.remove('hidden');
                initMain();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        });

        // --- Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ---
        function initMain() {
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
            onSnapshot(collection(db, "posts"), snap => {
                const feed = document.getElementById('feed');
                feed.innerHTML = "";
                let arr = [];
                snap.forEach(d => arr.push({id: d.id, ...d.data()}));
                arr.sort((a,b) => (b.at?.seconds || 0) - (a.at?.seconds || 0));
                arr.forEach(p => feed.innerHTML += renderPost(p));
            });

            // Ø¬Ù„Ø¨ Ø§Ù„Ù‚ØµØµ
            onSnapshot(collection(db, "stories"), snap => {
                const list = document.getElementById('stories-list');
                const add = list.children[0].outerHTML;
                list.innerHTML = add;
                snap.forEach(d => {
                    const s = d.data();
                    list.innerHTML += `
                        <div class="story" onclick="viewStory('${s.media}')">
                            <div class="story-ring"><img src="${s.media}"></div>
                            <span style="font-size:10px;">${s.author}</span>
                        </div>
                    `;
                });
            });
        }

        function renderPost(p) {
            const isMe = p.uid === me.uid;
            const liked = p.likes?.includes(me.uid);
            return `
                <div class="post">
                    ${isMe ? `<span class="delete-btn" onclick="deleteObj('posts', '${p.id}')">Ø­Ø°Ù ğŸ—‘ï¸</span>` : ''}
                    <div class="post-header" onclick="viewProfile('${p.uid}')">
                        <img src="${p.pfp || "https://ui-avatars.com/api/?name="+p.author}" class="avatar">
                        <div><b>${p.author}</b><br><small style="color:#999">@${p.username}</small></div>
                    </div>
                    <div>${p.text}</div>
                    ${p.media ? `<img src="${p.media}" class="post-img">` : ''}
                    <div class="post-actions">
                        <button class="action-btn" onclick="likePost('${p.id}', ${liked})">
                            ${liked ? 'â¤ï¸' : 'ğŸ¤'} ${p.likes?.length || 0}
                        </button>
                    </div>
                </div>
            `;
        }

        // --- Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© ---
        window.navTo = (id, el) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id + '-view').classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if(el) el.classList.add('active');
            if(id === 'chat') renderThreads();
        };

        window.createPost = async () => {
            const txt = document.getElementById('post-text').value;
            const file = document.getElementById('post-file').files[0];
            if(!txt && !file) return;
            const b64 = file ? await toB64(file) : "";
            await addDoc(collection(db, "posts"), {
                text: txt, media: b64, author: me.name, username: me.username, pfp: me.pfp, uid: me.uid, at: serverTimestamp(), likes: []
            });
            document.getElementById('post-text').value = "";
            navTo('home', document.querySelector('.nav-item'));
        };

        window.likePost = async (id, liked) => {
            const ref = doc(db, "posts", id);
            await updateDoc(ref, { likes: liked ? arrayRemove(me.uid) : arrayUnion(me.uid) });
        };

        window.deleteObj = async (coll, id) => {
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ")) await deleteDoc(doc(db, coll, id));
        };

        // --- Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© ---
        window.globalSearch = async (val) => {
            const res = document.getElementById('search-results');
            if(val.length < 2) { res.innerHTML = ""; return; }
            const q = query(collection(db, "users"));
            const snap = await getDocs(q);
            res.innerHTML = "";
            snap.forEach(d => {
                const u = d.data();
                if(u.name.toLowerCase().includes(val.toLowerCase()) || u.username.includes(val)) {
                    res.innerHTML += `
                        <div class="post" onclick="viewProfile('${u.uid}')" style="cursor:pointer; display:flex; align-items:center; gap:15px; margin-bottom:8px; padding:10px;">
                            <img src="${u.pfp || "https://ui-avatars.com/api/?name="+u.name}" class="avatar">
                            <div><b>${u.name}</b><br><small>@${u.username}</small></div>
                        </div>
                    `;
                }
            });
        };

        window.viewProfile = async (uid = me.uid) => {
            navTo('profile');
            const uDoc = await getDoc(doc(db, "users", uid));
            const u = uDoc.data();
            
            document.getElementById('prof-pfp').src = u.pfp || "https://ui-avatars.com/api/?name="+u.name;
            document.getElementById('prof-name').innerText = u.name;
            document.getElementById('prof-user').innerText = "@" + u.username;
            document.getElementById('stat-followers').innerText = u.followers?.length || 0;
            
            const actions = document.getElementById('prof-actions');
            actions.innerHTML = "";
            if(uid === me.uid) {
                actions.innerHTML = `<button class="btn btn-main" style="background:#eee; color:#333;" onclick="editProfile()">ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø§Ø¨ÙŠ âš™ï¸</button>
                                     <button class="btn btn-main" style="background:var(--danger); margin-top:8px;" onclick="signOut(auth).then(()=>location.reload())">Ø®Ø±ÙˆØ¬</button>`;
            } else {
                const following = me.following?.includes(uid);
                actions.innerHTML = `
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-main" onclick="toggleFollow('${uid}', ${following})">${following ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©' : 'Ù…ØªØ§Ø¨Ø¹Ø©'}</button>
                        <button class="btn btn-main" style="background:var(--accent);" onclick="openChat('${uid}', '${u.name}')">Ù…Ø±Ø§Ø³Ù„Ø©</button>
                    </div>
                `;
            }

            // Ø¬Ù„Ø¨ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®Øµ ÙÙ‚Ø·
            const qP = query(collection(db, "posts"), where("uid", "==", uid));
            const pSnap = await getDocs(qP);
            const pList = document.getElementById('prof-posts');
            pList.innerHTML = "";
            document.getElementById('stat-posts').innerText = pSnap.size;
            pSnap.forEach(d => pList.innerHTML += renderPost({id: d.id, ...d.data()}));
        };

        window.toggleFollow = async (uid, following) => {
            await updateDoc(doc(db, "users", me.uid), { following: following ? arrayRemove(uid) : arrayUnion(uid) });
            await updateDoc(doc(db, "users", uid), { followers: following ? arrayRemove(me.uid) : arrayUnion(me.uid) });
            const snap = await getDoc(doc(db, "users", me.uid)); me = snap.data(); // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§ØªÙŠ
            viewProfile(uid);
        };

        window.editProfile = async () => {
            const newName = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…:", me.name);
            if(newName) {
                await updateDoc(doc(db, "users", me.uid), { name: newName });
                location.reload();
            }
        };

        // --- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø´Ø·Ø© ---
        window.openChat = (uid, name) => {
            activeChatUid = uid;
            document.getElementById('chat-target-name').innerText = name;
            document.getElementById('chat-ui').style.display = 'flex';
            const cid = [me.uid, uid].sort().join("_");
            onSnapshot(query(collection(db, "messages"), where("cid", "==", cid)), snap => {
                const box = document.getElementById('chat-msgs');
                box.innerHTML = "";
                let msgs = [];
                snap.forEach(d => msgs.push(d.data()));
                msgs.sort((a,b) => (a.at?.seconds || 0) - (b.at?.seconds || 0));
                msgs.forEach(m => {
                    box.innerHTML += `
                        <div class="bubble ${m.from === me.uid ? 'me' : 'them'}">
                            ${m.text ? `<div>${m.text}</div>` : ''}
                            ${m.media ? `<img src="${m.media}" style="width:100%; border-radius:10px; margin-top:5px;">` : ''}
                        </div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        };

        window.sendMsg = async () => {
            const inp = document.getElementById('chat-input');
            if(!inp.value) return;
            const cid = [me.uid, activeChatUid].sort().join("_");
            await addDoc(collection(db, "messages"), { cid, text: inp.value, from: me.uid, at: serverTimestamp() });
            inp.value = "";
        };

        window.uploadChatImg = async (input) => {
            if(!input.files[0]) return;
            const b64 = await toB64(input.files[0]);
            const cid = [me.uid, activeChatUid].sort().join("_");
            await addDoc(collection(db, "messages"), { cid, media: b64, from: me.uid, at: serverTimestamp() });
        };

        window.closeChat = () => document.getElementById('chat-ui').style.display = 'none';

        async function renderThreads() {
            const list = document.getElementById('threads-list');
            list.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
            const snap = await getDocs(collection(db, "messages"));
            const uids = new Set();
            snap.forEach(d => {
                const m = d.data();
                if(m.cid.includes(me.uid)) {
                    const other = m.cid.split("_").find(id => id !== me.uid);
                    if(other) uids.add(other);
                }
            });
            list.innerHTML = uids.size ? "" : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª.";
            for(let id of uids) {
                const u = (await getDoc(doc(db, "users", id))).data();
                if(u) {
                    list.innerHTML += `
                        <div class="post" onclick="openChat('${u.uid}', '${u.name}')" style="cursor:pointer; display:flex; gap:15px; padding:10px;">
                            <img src="${u.pfp || "https://ui-avatars.com/api/?name="+u.name}" class="avatar">
                            <div><b>${u.name}</b><br><small>Ù…Ø±Ø§Ø³Ù„Ø© ÙÙˆØ±ÙŠØ©</small></div>
                        </div>`;
                }
            }
        }

        window.uploadMedia = async (input, type) => {
            if(!input.files[0]) return;
            const b64 = await toB64(input.files[0]);
            await addDoc(collection(db, type), { media: b64, author: me.name, uid: me.uid, at: serverTimestamp() });
            alert("ØªÙ… Ø§Ù„Ø±ÙØ¹!");
        };

        window.viewStory = (src) => {
            const win = window.open("");
            win.document.write(`<img src="${src}" style="width:100%; height:100vh; object-fit:contain; background:black;">`);
        };
    </script>
</body>
</html>

