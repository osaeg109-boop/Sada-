<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØµØ¯Ù‰ | Sada Social</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00b894;
            --secondary: #0984e3;
            --heart: #d63031;
            --bg: #f0f2f5;
            --white: #ffffff;
            --text-main: #1c1e21;
            --text-muted: #65676b;
            --border: #dddfe2;
        }

        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background-color: var(--bg); color: var(--text-main); padding-bottom: 80px; }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        header { 
            background: var(--white); padding: 10px 15px; position: sticky; top: 0; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        .logo { font-size: 24px; font-weight: 900; color: var(--primary); text-decoration: none; }
        .search-box { flex: 1; margin: 0 15px; position: relative; }
        .search-box input { width: 100%; padding: 8px 15px; border-radius: 20px; border: none; background: #f0f2f5; outline: none; }

        /* Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª */
        .feed { max-width: 550px; margin: 0 auto; padding: 15px; }
        .post { background: var(--white); border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .post-header { display: flex; align-items: center; margin-bottom: 12px; }
        .avatar { width: 42px; height: 42px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-left: 10px; border: 2px solid var(--white); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .user-name { font-weight: 700; font-size: 15px; }
        .post-time { font-size: 12px; color: var(--text-muted); }
        .post-content { font-size: 16px; line-height: 1.5; margin-bottom: 12px; white-space: pre-wrap; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„ØªÙØ§Ø¹Ù„ */
        .post-actions { display: flex; border-top: 1px solid #eee; border-bottom: 1px solid #eee; padding: 8px 0; margin-bottom: 10px; }
        .action-btn { flex: 1; background: none; border: none; color: var(--text-muted); font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; font-size: 14px; transition: 0.2s; }
        .action-btn.liked { color: var(--heart); }
        .action-btn:active { transform: scale(0.9); }

        /* Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª */
        .comments-section { background: #f8f9fa; border-radius: 8px; padding: 10px; margin-top: 10px; }
        .comment-item { font-size: 13px; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .comment-user { font-weight: 700; color: var(--secondary); margin-left: 5px; }
        .comment-input-area { display: flex; gap: 5px; margin-top: 10px; }
        .comment-input-area input { flex: 1; padding: 8px 12px; border-radius: 15px; border: 1px solid #ddd; font-size: 13px; }
        .comment-input-area button { background: var(--primary); color: white; border: none; border-radius: 15px; padding: 0 15px; cursor: pointer; }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© */
        .navbar { position: fixed; bottom: 0; width: 100%; background: var(--white); height: 65px; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #ddd; z-index: 1000; }
        .nav-link { color: #8a8d91; text-align: center; cursor: pointer; text-decoration: none; flex: 1; }
        .nav-link.active { color: var(--primary); }
        .nav-icon { font-size: 22px; display: block; }
        .nav-text { font-size: 11px; font-weight: bold; }

        /* Ø´Ø§Ø´Ø§Øª */
        .view { display: none; }
        .view.active { display: block; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #auth-view { position: fixed; inset: 0; background: white; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px; }
        .auth-card { width: 100%; max-width: 400px; text-align: center; }
        .input-f { width: 100%; padding: 15px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 15px; background: #f5f6f7; font-size: 16px; }
        .btn-f { width: 100%; padding: 15px; border-radius: 10px; border: none; background: var(--primary); color: white; font-weight: 800; font-size: 16px; cursor: pointer; }

        .hidden { display: none !important; }
        
        /* Ø²Ø± Ø­Ø°Ù */
        .del-btn { color: #ccc; font-size: 18px; margin-right: auto; cursor: pointer; }
        .del-btn:hover { color: red; }
    </style>
</head>
<body>

    <!-- Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="auth-view">
        <div class="auth-card">
            <h1 style="color:var(--primary); font-size: 40px; margin-bottom: 5px;">ØµØ¯Ù‰</h1>
            <p style="color:var(--text-muted); margin-bottom: 30px;">ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ Ø§Ù„Ø¢Ù†</p>
            <div id="auth-error" style="color:red; margin-bottom: 10px; font-size: 14px;"></div>
            <input type="email" id="email" class="input-f" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            <input type="password" id="password" class="input-f" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button class="btn-f" onclick="handleAuth()">Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„</button>
            <p style="margin-top:20px; font-size: 13px; color: gray;">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…Ø³Ø¬Ù„Ø§Ù‹</p>
        </div>
    </div>

    <!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
    <header id="app-header" class="hidden">
        <div class="logo">ØµØ¯Ù‰</div>
        <div class="search-box">
            <input type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ØµØ¯Ù‚Ø§Ø¡..." id="user-search" oninput="searchUsers()">
            <div id="search-results" style="position: absolute; width: 100%; background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-radius: 8px; z-index: 2000;"></div>
        </div>
    </header>

    <div id="app-body" class="hidden">
        
        <!-- Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <div id="home-view" class="view active feed">
            <div id="posts-container"></div>
        </div>

        <!-- Ù†Ø´Ø± -->
        <div id="add-view" class="view feed">
            <div class="post">
                <h3 style="margin-top:0">Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯</h3>
                <textarea id="post-text" style="width:100%; border:1px solid #ddd; border-radius:10px; padding:10px; font-family:inherit" rows="5" placeholder="Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªÙ‚ÙˆÙ„ØŸ"></textarea>
                <button class="btn-f" style="margin-top:10px" onclick="createPost()">Ù†Ø´Ø± Ø§Ù„Ø¢Ù†</button>
            </div>
        </div>

        <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
        <div id="chat-view" class="view feed">
            <h3>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø§ØµØ©</h3>
            <div id="inbox-container"></div>
        </div>

        <!-- Ø­Ø³Ø§Ø¨ÙŠ -->
        <div id="profile-view" class="view feed">
            <div class="post" style="text-align: center;">
                <div class="avatar" style="width: 80px; height: 80px; margin: 0 auto 10px; font-size: 35px;" id="my-avatar">ØŸ</div>
                <h2 id="my-name" style="margin-bottom:5px">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>
                <p id="my-email" style="color: var(--text-muted); margin-bottom: 20px;"></p>
                <button class="btn-f" style="background:#ff7675" onclick="logout()">Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨</button>
            </div>
        </div>

        <!-- Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ -->
        <div id="other-view" class="view feed">
            <button onclick="nav('home')" style="background:none; border:none; color:var(--primary); cursor:pointer">â† Ø¹ÙˆØ¯Ø©</button>
            <div class="post" style="text-align: center;">
                <div class="avatar" style="width: 80px; height: 80px; margin: 0 auto 10px; font-size: 35px;" id="other-avatar">ØŸ</div>
                <h2 id="other-name">...</h2>
                <button class="btn-f" onclick="document.getElementById('msg-area').classList.toggle('hidden')">âœ‰ï¸ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©</button>
                <div id="msg-area" class="hidden" style="margin-top:15px">
                    <input type="text" id="direct-msg-text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." class="input-f">
                    <button class="btn-f" style="background:var(--secondary)" onclick="sendPrivateMsg()">Ø¥Ø±Ø³Ø§Ù„</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Ø§Ù„Ù†Ø§Ù Ø¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠØ© -->
    <nav class="navbar hidden" id="app-nav">
        <div class="nav-link active" onclick="nav('home', this)">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-text">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </div>
        <div class="nav-link" onclick="nav('chat', this)">
            <span class="nav-icon">ğŸ’¬</span>
            <span class="nav-text">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</span>
        </div>
        <div class="nav-link" onclick="nav('add', this)">
            <span class="nav-icon">â•</span>
            <span class="nav-text">Ù†Ø´Ø±</span>
        </div>
        <div class="nav-link" onclick="nav('profile', this)">
            <span class="nav-icon">ğŸ‘¤</span>
            <span class="nav-text">Ø­Ø³Ø§Ø¨ÙŠ</span>
        </div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, serverTimestamp, doc, getDoc, setDoc, deleteDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAhg6oTG1EJ44ST1zkkeYvKpfLMD2JDV3M",
            authDomain: "fir-c3e88.firebaseapp.com",
            projectId: "fir-c3e88",
            storageBucket: "fir-c3e88.firebasestorage.app",
            messagingSenderId: "202130175288",
            appId: "1:202130175288:web:0d7ad99c3c828501b4fdcd",
            measurementId: "G-J47JVNC93Q"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let user = null;
        let targetId = null;

        // Ø§Ù„ØªÙ†Ù‚Ù„
        window.nav = (id, el) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id + '-view').classList.add('active');
            if(el) {
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                el.classList.add('active');
            }
        };

        // Ø§Ù„Ø¯Ø®ÙˆÙ„
        window.handleAuth = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try {
                const res = await signInWithEmailAndPassword(auth, email, pass).catch(async (err) => {
                    if (err.code === 'auth/user-not-found' || err.code === 'auth/invalid-credential') {
                        return await createUserWithEmailAndPassword(auth, email, pass);
                    }
                    throw err;
                });
                
                await setDoc(doc(db, "users", res.user.uid), {
                    name: email.split('@')[0],
                    email: email,
                    uid: res.user.uid
                }, { merge: true });
            } catch (e) {
                document.getElementById('auth-error').innerText = "Ø®Ø·Ø£: " + e.message;
            }
        };

        window.logout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, async (u) => {
            if(u) {
                user = u;
                document.getElementById('auth-view').classList.add('hidden');
                document.getElementById('app-header').classList.remove('hidden');
                document.getElementById('app-body').classList.remove('hidden');
                document.getElementById('app-nav').classList.remove('hidden');
                
                const snap = await getDoc(doc(db, "users", u.uid));
                if(snap.exists()){
                    document.getElementById('my-name').innerText = snap.data().name;
                    document.getElementById('my-email').innerText = snap.data().email;
                    document.getElementById('my-avatar').innerText = snap.data().name[0].toUpperCase();
                }
                loadPosts();
                loadMessages();
            } else {
                document.getElementById('auth-view').classList.remove('hidden');
            }
        });

        // Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª
        window.createPost = async () => {
            const txt = document.getElementById('post-text').value;
            if(!txt.trim()) return;
            const snap = await getDoc(doc(db, "users", user.uid));
            await addDoc(collection(db, "posts"), {
                text: txt,
                uid: user.uid,
                author: snap.data().name,
                likes: [],
                comments: [],
                at: serverTimestamp()
            });
            document.getElementById('post-text').value = "";
            nav('home', document.querySelector('.nav-link'));
        };

        function loadPosts() {
            const q = query(collection(db, "posts"), orderBy("at", "desc"));
            onSnapshot(q, (snap) => {
                const container = document.getElementById('posts-container');
                container.innerHTML = "";
                snap.forEach(d => {
                    const p = d.data();
                    const isLiked = p.likes?.includes(user.uid);
                    const card = document.createElement('div');
                    card.className = "post";
                    card.innerHTML = `
                        <div class="post-header">
                            <div class="avatar" onclick="viewOther('${p.uid}')">${p.author[0].toUpperCase()}</div>
                            <div class="user-meta" onclick="viewOther('${p.uid}')">
                                <div class="user-name">${p.author}</div>
                                <div class="post-time">Ù…Ù†Ø° Ù‚Ù„ÙŠÙ„</div>
                            </div>
                            ${p.uid === user.uid ? `<div class="del-btn" onclick="deletePost('${d.id}')">Ã—</div>` : ''}
                        </div>
                        <div class="post-content">${p.text}</div>
                        <div class="post-actions">
                            <button class="action-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${d.id}', ${isLiked})">
                                ${isLiked ? 'â¤ï¸' : 'ğŸ¤'} ${p.likes?.length || 0} Ø£Ø¹Ø¬Ø¨Ù†ÙŠ
                            </button>
                            <button class="action-btn" onclick="document.getElementById('c-area-${d.id}').classList.toggle('hidden')">
                                ğŸ’¬ ØªØ¹Ù„ÙŠÙ‚
                            </button>
                        </div>
                        <div id="c-area-${d.id}" class="comments-section">
                            <div id="comments-list-${d.id}">
                                ${(p.comments || []).map(c => `<div class="comment-item"><span class="comment-user">${c.user}:</span> ${c.text}</div>`).join('')}
                            </div>
                            <div class="comment-input-area">
                                <input type="text" id="input-${d.id}" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ...">
                                <button onclick="addComment('${d.id}')">Ø¥Ø±Ø³Ø§Ù„</button>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            });
        }

        window.toggleLike = async (postId, isLiked) => {
            const postRef = doc(db, "posts", postId);
            await updateDoc(postRef, {
                likes: isLiked ? arrayRemove(user.uid) : arrayUnion(user.uid)
            });
        };

        window.addComment = async (postId) => {
            const input = document.getElementById('input-' + postId);
            if(!input.value.trim()) return;
            const snap = await getDoc(doc(db, "users", user.uid));
            const postRef = doc(db, "posts", postId);
            await updateDoc(postRef, {
                comments: arrayUnion({
                    user: snap.data().name,
                    text: input.value,
                    uid: user.uid
                })
            });
            input.value = "";
        };

        window.deletePost = async (id) => {
            if(confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) await deleteDoc(doc(db, "posts", id));
        };

        // Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„Ø¨Ø­Ø«
        window.viewOther = async (uid) => {
            if(uid === user.uid) return nav('profile');
            targetId = uid;
            const snap = await getDoc(doc(db, "users", uid));
            document.getElementById('other-name').innerText = snap.data().name;
            document.getElementById('other-avatar').innerText = snap.data().name[0].toUpperCase();
            nav('other');
        };

        window.sendPrivateMsg = async () => {
            const txt = document.getElementById('direct-msg-text').value;
            if(!txt.trim()) return;
            const mySnap = await getDoc(doc(db, "users", user.uid));
            await addDoc(collection(db, "messages"), {
                text: txt,
                from: user.uid,
                fromName: mySnap.data().name,
                to: targetId,
                at: serverTimestamp()
            });
            alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„ØªÙƒ!");
            document.getElementById('direct-msg-text').value = "";
            nav('chat');
        };

        function loadMessages() {
            const q = query(collection(db, "messages"), where("to", "==", user.uid), orderBy("at", "desc"));
            onSnapshot(q, (snap) => {
                const container = document.getElementById('inbox-container');
                container.innerHTML = snap.empty ? "<p style='text-align:center; color:gray'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</p>" : "";
                snap.forEach(d => {
                    const m = d.data();
                    container.innerHTML += `
                        <div class="post" style="border-right: 4px solid var(--secondary)">
                            <strong>Ù…Ù†: ${m.fromName}</strong><br>
                            <p>${m.text}</p>
                        </div>
                    `;
                });
            });
        }
    </script>
</body>
</html>

