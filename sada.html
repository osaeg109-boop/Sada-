<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØµØ¯Ù‰ | Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6c5ce7;
            --secondary: #a29bfe;
            --accent: #00cec9;
            --bg: #f4f7f6;
            --card: #ffffff;
            --text: #2d3436;
            --light-text: #636e72;
            --danger: #d63031;
        }

        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); padding-bottom: 80px; overflow-x: hidden; }

        /* Auth Screen */
        #auth-screen { position: fixed; inset: 0; z-index: 9999; background: var(--primary); display: flex; align-items: center; justify-content: center; padding: 20px; }
        .auth-container { background: white; width: 100%; max-width: 400px; padding: 30px; border-radius: 25px; text-align: center; }
        .inp { width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #eee; border-radius: 12px; outline: none; }
        .btn-main { width: 100%; padding: 14px; border-radius: 12px; border: none; background: var(--primary); color: white; font-weight: bold; cursor: pointer; }

        /* Header */
        header { background: white; padding: 15px 20px; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .logo { font-size: 24px; font-weight: 900; color: var(--primary); }

        /* Navigation */
        nav { position: fixed; bottom: 0; width: 100%; background: white; height: 70px; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #999; cursor: pointer; font-size: 11px; font-weight: bold; }
        .nav-item.active { color: var(--primary); }

        /* Views */
        .view { display: none; padding: 15px; max-width: 600px; margin: 0 auto; }
        .view.active { display: block; }

        /* Profile & Avatars */
        .avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background: #eee; flex-shrink: 0; }
        .p-avatar-large { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid var(--primary); }

        /* Posts */
        .post { background: white; border-radius: 20px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .post-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
        .post-img { width: 100%; border-radius: 15px; margin-top: 10px; }

        /* Search & Lists */
        .search-bar { width: 100%; padding: 12px; border-radius: 12px; border: none; background: #eee; margin-bottom: 15px; outline: none; }
        .list-item { display: flex; align-items: center; gap: 15px; padding: 12px; background: white; border-radius: 15px; margin-bottom: 8px; cursor: pointer; }

        /* Chat Window */
        #chat-window { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: none; flex-direction: column; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .bubble { max-width: 75%; padding: 10px 15px; border-radius: 15px; font-size: 14px; }
        .bubble.me { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .bubble.them { align-self: flex-start; background: white; border-bottom-left-radius: 2px; border: 1px solid #ddd; }

        /* Privacy Badge */
        .badge { font-size: 10px; padding: 2px 8px; border-radius: 10px; margin-right: 5px; color: white; }
        .badge-public { background: #2ecc71; }
        .badge-private { background: #e67e22; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- Auth Screen -->
    <div id="auth-screen">
        <div class="auth-container">
            <h1 class="logo" style="font-size: 40px; margin-bottom: 20px;">ØµØ¯Ù‰</h1>
            <div id="reg-fields">
                <input type="text" id="join-name" class="inp" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
                <input type="text" id="join-user" class="inp" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (English)">
            </div>
            <input type="email" id="join-email" class="inp" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            <input type="password" id="join-pass" class="inp" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button class="btn-main" onclick="handleAuth()">Ø§Ø³ØªÙ…Ø±Ø§Ø±</button>
            <p onclick="toggleAuth()" id="auth-switch" style="cursor:pointer; color:var(--primary); font-size:14px; margin-top:15px;">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ</p>
        </div>
    </div>

    <!-- App Header -->
    <header id="app-header" class="hidden">
        <div class="logo">ØµØ¯Ù‰</div>
        <div onclick="navTo('chat')" style="cursor:pointer; font-size:20px;">âœ‰ï¸</div>
    </header>

    <main id="app-main" class="hidden">
        <!-- Home View -->
        <div id="home-view" class="view active">
            <div id="feed"></div>
        </div>

        <!-- Post View -->
        <div id="post-view" class="view">
            <div class="post">
                <h3>Ù†Ø´Ø± Ø¬Ø¯ÙŠØ¯</h3>
                <textarea id="post-text" class="inp" style="height:100px; resize:none;" placeholder="Ù…Ø§Ø°Ø§ ÙŠØ¯ÙˆØ± ÙÙŠ Ø°Ù‡Ù†ÙƒØŸ"></textarea>
                <input type="file" id="post-file" class="inp" accept="image/*">
                <button class="btn-main" onclick="submitPost()">Ù†Ø´Ø± Ø§Ù„Ø¢Ù†</button>
            </div>
        </div>

        <!-- Messages View -->
        <div id="chat-view" class="view">
            <input type="text" class="search-bar" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ØµØ¯Ù‚Ø§Ø¡..." oninput="searchUsers(this.value)">
            <div id="search-results" style="margin-bottom:20px;"></div>
            <h4 id="threads-title">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©</h4>
            <div id="threads"></div>
        </div>

        <!-- Profile View -->
        <div id="profile-view" class="view">
            <div class="post" style="text-align: center;">
                <div style="position:relative; display:inline-block;">
                    <img id="my-pfp" class="p-avatar-large" src="">
                    <label style="position:absolute; bottom:5px; right:5px; background:var(--primary); color:white; border-radius:50%; width:30px; height:30px; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                        ğŸ“·<input type="file" hidden onchange="updateProfilePic(this)">
                    </label>
                </div>
                <h2 id="my-name-display" style="margin:10px 0 0 0;">...</h2>
                <p id="my-user-display" style="color:var(--light-text); margin:5px 0;">@...</p>
                
                <div style="margin:20px 0; background:#f9f9f9; padding:15px; border-radius:15px;">
                    <p style="font-weight:bold; margin-bottom:10px;">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®ØµÙˆØµÙŠØ©</p>
                    <div style="display:flex; justify-content:center; gap:10px;">
                        <button id="btn-public" class="btn-main" style="width:auto; padding:8px 20px; font-size:13px;" onclick="setPrivacy(true)">Ø¹Ø§Ù…</button>
                        <button id="btn-private" class="btn-main" style="width:auto; padding:8px 20px; font-size:13px; background:#ddd; color:#555;" onclick="setPrivacy(false)">Ø®Ø§Øµ</button>
                    </div>
                </div>

                <button class="btn-main" style="background:var(--danger);" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </main>

    <!-- Chat Pop-up -->
    <div id="chat-window">
        <div style="background:white; padding:15px; border-bottom:1px solid #eee; display:flex; align-items:center; gap:15px;">
            <button onclick="closeChat()" style="border:none; background:none; font-size:22px;">âœ•</button>
            <img id="chat-target-img" class="avatar" style="width:35px; height:35px;">
            <b id="chat-target-name">...</b>
        </div>
        <div id="chat-messages"></div>
        <div style="background:white; padding:15px; display:flex; gap:10px;">
            <input type="text" id="chat-input" class="inp" style="margin:0;" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§...">
            <button onclick="sendMsg()" style="background:var(--primary); color:white; border:none; width:60px; border-radius:12px;">â¤</button>
        </div>
    </div>

    <!-- Bottom Nav -->
    <nav id="app-nav" class="hidden">
        <div class="nav-item active" onclick="navTo('home', this)"><i>ğŸ </i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="nav-item" onclick="navTo('post', this)"><i>â•</i>Ù†Ø´Ø±</div>
        <div class="nav-item" onclick="navTo('chat', this)"><i>ğŸ’¬</i>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</div>
        <div class="nav-item" onclick="navTo('profile', this)"><i>ğŸ‘¤</i>Ø­Ø³Ø§Ø¨ÙŠ</div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, getDoc, setDoc, getDocs, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAhg6oTG1EJ44ST1zkkeYvKpfLMD2JDV3M",
            authDomain: "fir-c3e88.firebaseapp.com",
            projectId: "fir-c3e88",
            storageBucket: "fir-c3e88.firebasestorage.app",
            messagingSenderId: "202130175288",
            appId: "1:202130175288:web:0d7ad99c3c828501b4fdcd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let me = null;
        let isLogin = false;
        let activeChat = null;

        // --- Image Utilities ---
        const toBase64 = (file) => new Promise(resolve => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = e => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX = 600;
                    let w = img.width, h = img.height;
                    if(w > h) { if(w > MAX) { h *= MAX/w; w = MAX; } }
                    else { if(h > MAX) { w *= MAX/h; h = MAX; } }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    resolve(canvas.toBase64 = canvas.toDataURL('image/jpeg', 0.6));
                }
            }
        });

        // --- Auth ---
        window.toggleAuth = () => {
            isLogin = !isLogin;
            document.getElementById('reg-fields').classList.toggle('hidden', isLogin);
            document.getElementById('auth-switch').innerText = isLogin ? "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø§Ø´ØªØ±Ùƒ" : "Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ";
        };

        window.handleAuth = async () => {
            const email = document.getElementById('join-email').value;
            const pass = document.getElementById('join-pass').value;
            try {
                if(isLogin) {
                    await signInWithEmailAndPassword(auth, email, pass);
                } else {
                    const name = document.getElementById('join-name').value;
                    const user = document.getElementById('join-user').value.toLowerCase();
                    const res = await createUserWithEmailAndPassword(auth, email, pass);
                    await setDoc(doc(db, "users", res.user.uid), {
                        name, username: user, uid: res.user.uid, 
                        pfp: "", isPublic: true
                    });
                }
            } catch(e) { alert(e.message); }
        };

        onAuthStateChanged(auth, async user => {
            if(user) {
                const snap = await getDoc(doc(db, "users", user.uid));
                me = snap.data();
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-header').classList.remove('hidden');
                document.getElementById('app-main').classList.remove('hidden');
                document.getElementById('app-nav').classList.remove('hidden');
                updateProfileUI();
                initFeed();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        });

        const updateProfileUI = () => {
            document.getElementById('my-name-display').innerText = me.name;
            document.getElementById('my-user-display').innerText = "@" + me.username;
            document.getElementById('my-pfp').src = me.pfp || "https://ui-avatars.com/api/?name=" + me.name;
            
            const isPub = me.isPublic !== false;
            document.getElementById('btn-public').style.background = isPub ? "var(--primary)" : "#ddd";
            document.getElementById('btn-public').style.color = isPub ? "white" : "#555";
            document.getElementById('btn-private').style.background = !isPub ? "var(--primary)" : "#ddd";
            document.getElementById('btn-private').style.color = !isPub ? "white" : "#555";
        };

        window.logout = () => signOut(auth).then(() => location.reload());

        // --- Profile Actions ---
        window.updateProfilePic = async (input) => {
            if(!input.files[0]) return;
            const b64 = await toBase64(input.files[0]);
            await updateDoc(doc(db, "users", me.uid), { pfp: b64 });
            me.pfp = b64;
            updateProfileUI();
        };

        window.setPrivacy = async (val) => {
            await updateDoc(doc(db, "users", me.uid), { isPublic: val });
            me.isPublic = val;
            updateProfileUI();
        };

        // --- Navigation ---
        window.navTo = (id, el) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id + '-view').classList.add('active');
            if(el) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                el.classList.add('active');
            }
            if(id === 'chat') renderThreads();
        };

        // --- Home Feed ---
        function initFeed() {
            onSnapshot(collection(db, "posts"), snap => {
                const list = document.getElementById('feed');
                list.innerHTML = "";
                let arr = [];
                snap.forEach(d => arr.push(d.data()));
                arr.sort((a,b) => (b.at?.seconds || 0) - (a.at?.seconds || 0));
                
                arr.forEach(p => {
                    list.innerHTML += `
                        <div class="post">
                            <div class="post-header">
                                <img src="${p.pfp || "https://ui-avatars.com/api/?name="+p.author}" class="avatar">
                                <div><b>${p.author}</b><br><small style="color:var(--light-text)">@${p.username}</small></div>
                            </div>
                            <div>${p.text}</div>
                            ${p.media ? `<img src="${p.media}" class="post-img">` : ''}
                        </div>
                    `;
                });
            });
        }

        window.submitPost = async () => {
            const txt = document.getElementById('post-text').value;
            const file = document.getElementById('post-file').files[0];
            let media = "";
            if(file) media = await toBase64(file);
            if(!txt && !media) return;
            
            await addDoc(collection(db, "posts"), {
                text: txt, media, author: me.name, username: me.username, pfp: me.pfp, uid: me.uid, at: serverTimestamp()
            });
            document.getElementById('post-text').value = "";
            document.getElementById('post-file').value = "";
            navTo('home', document.querySelectorAll('.nav-item')[0]);
        };

        // --- Search & Messaging ---
        window.searchUsers = async (val) => {
            const resDiv = document.getElementById('search-results');
            if(val.length < 2) { resDiv.innerHTML = ""; return; }
            
            const q = query(collection(db, "users"));
            const snap = await getDocs(q);
            resDiv.innerHTML = "";
            snap.forEach(d => {
                const u = d.data();
                if(u.uid !== me.uid && (u.name.toLowerCase().includes(val.toLowerCase()) || u.username.includes(val))) {
                    resDiv.innerHTML += `
                        <div class="list-item" onclick="openChat('${u.uid}', '${u.name}', '${u.pfp}')">
                            <img src="${u.pfp || "https://ui-avatars.com/api/?name="+u.name}" class="avatar">
                            <div>
                                <b>${u.name}</b> <span class="badge ${u.isPublic ? 'badge-public' : 'badge-private'}">${u.isPublic ? 'Ø¹Ø§Ù…' : 'Ø®Ø§Øµ'}</span>
                                <br><small>@${u.username}</small>
                            </div>
                        </div>
                    `;
                }
            });
        };

        window.openChat = (uid, name, pfp) => {
            activeChat = { uid, name, pfp };
            document.getElementById('chat-target-name').innerText = name;
            document.getElementById('chat-target-img').src = pfp || "https://ui-avatars.com/api/?name="+name;
            document.getElementById('chat-window').style.display = 'flex';
            
            const convoId = [me.uid, uid].sort().join("_");
            onSnapshot(query(collection(db, "messages"), where("convoId", "==", convoId)), snap => {
                const box = document.getElementById('chat-messages');
                box.innerHTML = "";
                let msgs = [];
                snap.forEach(d => msgs.push(d.data()));
                msgs.sort((a,b) => (a.at?.seconds || 0) - (b.at?.seconds || 0));
                msgs.forEach(m => {
                    box.innerHTML += `<div class="bubble ${m.from === me.uid ? 'me' : 'them'}">${m.text}</div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        };

        window.closeChat = () => document.getElementById('chat-window').style.display = 'none';

        window.sendMsg = async () => {
            const inp = document.getElementById('chat-input');
            if(!inp.value) return;
            const convoId = [me.uid, activeChat.uid].sort().join("_");
            await addDoc(collection(db, "messages"), {
                convoId, text: inp.value, from: me.uid, to: activeChat.uid, at: serverTimestamp()
            });
            inp.value = "";
        };

        async function renderThreads() {
            const list = document.getElementById('threads');
            list.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
            const snap = await getDocs(collection(db, "messages"));
            const uids = new Set();
            snap.forEach(d => {
                const m = d.data();
                if(m.from === me.uid) uids.add(m.to);
                if(m.to === me.uid) uids.add(m.from);
            });
            list.innerHTML = uids.size ? "" : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª.";
            for(let id of uids) {
                const u = (await getDoc(doc(db, "users", id))).data();
                if(u) {
                    list.innerHTML += `
                        <div class="list-item" onclick="openChat('${u.uid}', '${u.name}', '${u.pfp}')">
                            <img src="${u.pfp || "https://ui-avatars.com/api/?name="+u.name}" class="avatar">
                            <div><b>${u.name}</b><br><small>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</small></div>
                        </div>
                    `;
                }
            }
        }
    </script>
</body>
</html>

