<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sada Social Pro | ØµØ¯Ù‰</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00b894;
            --secondary: #0984e3;
            --danger: #ff7675;
            --bg: #f0f2f5;
            --card: #ffffff;
            --text: #2d3436;
        }

        * { box-sizing: border-box; font-family: 'Noto Sans Arabic', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); padding-bottom: 75px; }

        /* Ø§Ù„Ø´Ø§Ø´Ø§Øª */
        .view { display: none; padding: 15px; max-width: 600px; margin: 0 auto; }
        .view.active { display: block; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        header { 
            background: var(--card); padding: 12px 20px; position: sticky; top: 0; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .logo { font-size: 24px; font-weight: 900; color: var(--primary); text-decoration: none; }

        /* ÙƒØ±ÙˆØª Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª */
        .post-card { background: var(--card); border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.02); }
        .post-header { display: flex; align-items: center; margin-bottom: 12px; }
        .avatar { width: 45px; height: 45px; border-radius: 14px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-left: 12px; font-size: 18px; }
        .user-info .name { font-weight: 700; font-size: 16px; margin: 0; }
        .user-info .username { font-size: 12px; color: var(--secondary); font-weight: bold; }
        .post-content { font-size: 16px; line-height: 1.6; margin-bottom: 15px; white-space: pre-wrap; }

        /* Ø§Ù„ØªÙØ§Ø¹Ù„ */
        .post-actions { display: flex; border-top: 1px solid #f1f2f6; padding-top: 10px; gap: 10px; }
        .action-btn { flex: 1; border: none; background: #f8f9fa; padding: 8px; border-radius: 10px; color: #636e72; font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .action-btn.liked { color: #d63031; background: #fff5f5; }

        /* Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª */
        .comment-box { background: #f1f2f6; border-radius: 10px; padding: 8px 12px; margin-top: 8px; font-size: 13px; }
        .comment-user { font-weight: 900; color: var(--secondary); margin-left: 5px; }

        /* Ù†Ø§Ù Ø¨Ø§Ø± Ø³ÙÙ„ÙŠØ© */
        nav { position: fixed; bottom: 0; width: 100%; background: var(--card); height: 65px; display: flex; border-top: 1px solid #eee; z-index: 1000; box-shadow: 0 -5px 15px rgba(0,0,0,0.03); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #b2bec3; cursor: pointer; font-size: 10px; font-weight: bold; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 22px; margin-bottom: 2px; }

        /* Ø§Ù„Ø¨Ø­Ø« */
        .search-container { background: #f1f2f6; border-radius: 12px; display: flex; align-items: center; padding: 5px 15px; margin-bottom: 20px; }
        .search-container input { background: none; border: none; flex: 1; padding: 10px; outline: none; font-size: 15px; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #auth-screen { position: fixed; inset: 0; background: #fff; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
        .auth-input { width: 100%; max-width: 350px; padding: 15px; margin-bottom: 15px; border: 2px solid #f1f2f6; border-radius: 12px; font-size: 16px; outline: none; transition: 0.3s; }
        .auth-input:focus { border-color: var(--primary); }
        .btn-primary { width: 100%; max-width: 350px; padding: 15px; border-radius: 12px; border: none; background: var(--primary); color: white; font-weight: 800; font-size: 17px; cursor: pointer; box-shadow: 0 8px 20px rgba(0,184,148,0.3); }

        .hidden { display: none !important; }
        .badge { background: var(--secondary); color: white; padding: 2px 8px; border-radius: 5px; font-size: 10px; margin-right: 5px; }
    </style>
</head>
<body>

    <!-- Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="auth-screen">
        <h1 style="color:var(--primary); font-size: 48px; margin-bottom: 0;">ØµØ¯Ù‰</h1>
        <p style="color:#636e72; margin-bottom: 30px;">Ø¹Ø§Ù„Ù…Ùƒ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</p>
        
        <div id="auth-error" style="color:red; margin-bottom:10px; font-size:13px; text-align: center;"></div>
        
        <div id="username-field" class="hidden">
            <input type="text" id="reg-username" class="auth-input" placeholder="Ø§Ø®ØªØ± Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… ÙØ±ÙŠØ¯ (ÙŠÙˆØ²Ø± Ù†ÙŠÙ…)">
        </div>
        
        <input type="email" id="auth-email" class="auth-input" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        <input type="password" id="auth-pass" class="auth-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        
        <button class="btn-primary" onclick="handleAuth()" id="auth-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        <button style="background:none; border:none; color:var(--secondary); margin-top:20px; font-weight:700; cursor:pointer;" onclick="toggleAuthMode()" id="toggle-btn">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†</button>
    </div>

    <!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
    <header id="header" class="hidden">
        <a href="#" class="logo">ØµØ¯Ù‰</a>
        <div style="font-size: 20px;">ğŸ””</div>
    </header>

    <div id="main-content" class="hidden">
        
        <!-- Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <div id="home-view" class="view active">
            <div id="posts-list"></div>
        </div>

        <!-- Ø§Ù„Ø¨Ø­Ø« -->
        <div id="search-view" class="view">
            <div class="search-container">
                <i>ğŸ”</i>
                <input type="text" id="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† @ÙŠÙˆØ²Ø±_Ù†ÙŠÙ…..." oninput="searchUsers()">
            </div>
            <div id="search-results"></div>
        </div>

        <!-- Ø§Ù„Ù†Ø´Ø± -->
        <div id="add-view" class="view">
            <div class="post-card">
                <h3>Ù…Ø§Ø°Ø§ ÙŠØ¯ÙˆØ± ÙÙŠ Ø°Ù‡Ù†ÙƒØŸ</h3>
                <textarea id="post-text" style="width:100%; height:150px; border:none; background:#f9f9f9; border-radius:10px; padding:15px; font-size:18px; outline:none; resize:none;" placeholder="Ø§ÙƒØªØ¨ ÙÙƒØ±ØªÙƒ Ù‡Ù†Ø§..."></textarea>
                <button class="btn-primary" style="margin-top:15px;" onclick="createPost()">Ù†Ø´Ø± ÙÙŠ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹</button>
            </div>
        </div>

        <!-- Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
        <div id="profile-view" class="view">
            <div class="post-card" style="text-align: center; padding: 40px 20px;">
                <div class="avatar" style="width:100px; height:100px; margin:0 auto 15px; font-size:40px;" id="p-avatar">ØŸ</div>
                <h2 id="p-name" style="margin:0;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>
                <div id="p-username" style="color:var(--secondary); font-weight:900; margin-bottom:20px;">@username</div>
                <button class="btn-primary" style="background:var(--danger); box-shadow:none; padding:10px;" onclick="logout()">Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨</button>
            </div>
        </div>

    </div>

    <!-- Ù†Ø§Ù Ø¨Ø§Ø± -->
    <nav id="navbar" class="hidden">
        <div class="nav-item active" onclick="navTo('home', this)"><i>ğŸ </i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
        <div class="nav-item" onclick="navTo('search', this)"><i>ğŸ”</i><span>Ø§Ù„Ø¨Ø­Ø«</span></div>
        <div class="nav-item" onclick="navTo('add', this)"><i>â•</i><span>Ù†Ø´Ø±</span></div>
        <div class="nav-item" onclick="navTo('profile', this)"><i>ğŸ‘¤</i><span>Ø­Ø³Ø§Ø¨ÙŠ</span></div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, serverTimestamp, doc, getDoc, setDoc, deleteDoc, updateDoc, arrayUnion, arrayRemove, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAhg6oTG1EJ44ST1zkkeYvKpfLMD2JDV3M",
            authDomain: "fir-c3e88.firebaseapp.com",
            projectId: "fir-c3e88",
            storageBucket: "fir-c3e88.firebasestorage.app",
            messagingSenderId: "202130175288",
            appId: "1:202130175288:web:0d7ad99c3c828501b4fdcd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let user = null;
        let isLogin = true;

        window.toggleAuthMode = () => {
            isLogin = !isLogin;
            document.getElementById('username-field').classList.toggle('hidden');
            document.getElementById('auth-btn').innerText = isLogin ? "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„" : "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯";
            document.getElementById('toggle-btn').innerText = isLogin ? "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†" : "Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ Ø§Ø¯Ø®Ù„ Ù‡Ù†Ø§";
        };

        window.handleAuth = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const username = document.getElementById('reg-username').value.trim().toLowerCase();
            const errDiv = document.getElementById('auth-error');

            try {
                if (isLogin) {
                    await signInWithEmailAndPassword(auth, email, pass);
                } else {
                    if(!username) throw new Error("ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…!");
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ÙŠÙˆØ²Ø± Ù†ÙŠÙ… ØºÙŠØ± Ù…Ø£Ø®ÙˆØ°
                    const q = query(collection(db, "users"), where("username", "==", username));
                    const check = await getDocs(q);
                    if(!check.empty) throw new Error("Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆØ²Ø± Ù†ÙŠÙ… Ù…Ø£Ø®ÙˆØ° Ø¨Ø§Ù„ÙØ¹Ù„!");

                    const res = await createUserWithEmailAndPassword(auth, email, pass);
                    await setDoc(doc(db, "users", res.user.uid), {
                        name: email.split('@')[0],
                        username: username,
                        email: email,
                        uid: res.user.uid
                    });
                }
            } catch (e) {
                errDiv.innerText = "ØªÙ†Ø¨ÙŠÙ‡: " + e.message;
            }
        };

        window.logout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, async (u) => {
            if(u) {
                user = u;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('header').classList.remove('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('navbar').classList.remove('hidden');
                
                const snap = await getDoc(doc(db, "users", u.uid));
                if(snap.exists()){
                    const d = snap.data();
                    document.getElementById('p-name').innerText = d.name;
                    document.getElementById('p-username').innerText = "@" + d.username;
                    document.getElementById('p-avatar').innerText = d.name[0].toUpperCase();
                }
                loadPosts();
            }
        });

        window.navTo = (id, el) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id + '-view').classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
        };

        window.createPost = async () => {
            const txt = document.getElementById('post-text').value;
            if(!txt.trim()) return;
            const uSnap = await getDoc(doc(db, "users", user.uid));
            const userData = uSnap.data();
            
            await addDoc(collection(db, "posts"), {
                text: txt,
                uid: user.uid,
                author: userData.name,
                username: userData.username,
                likes: [],
                comments: [],
                at: serverTimestamp()
            });
            document.getElementById('post-text').value = "";
            navTo('home', document.querySelector('.nav-item'));
        };

        function loadPosts() {
            const q = query(collection(db, "posts"), orderBy("at", "desc"));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('posts-list');
                list.innerHTML = "";
                snap.forEach(d => {
                    const p = d.data();
                    const isLiked = p.likes?.includes(user.uid);
                    const div = document.createElement('div');
                    div.className = "post-card";
                    div.innerHTML = `
                        <div class="post-header">
                            <div class="avatar">${p.author[0].toUpperCase()}</div>
                            <div class="user-info">
                                <p class="name">${p.author} <span class="badge">Ù…ÙˆØ«Ù‚</span></p>
                                <p class="username">@${p.username}</p>
                            </div>
                            ${p.uid === user.uid ? `<button onclick="deletePost('${d.id}')" style="margin-right:auto; border:none; color:#ccc; background:none; cursor:pointer">ğŸ—‘</button>` : ''}
                        </div>
                        <div class="post-content">${p.text}</div>
                        <div class="post-actions">
                            <button class="action-btn ${isLiked ? 'liked' : ''}" onclick="likePost('${d.id}', ${isLiked})">
                                ${isLiked ? 'â¤ï¸' : 'ğŸ¤'} ${p.likes?.length || 0}
                            </button>
                            <button class="action-btn" onclick="openComments('${d.id}')">ğŸ’¬ ${p.comments?.length || 0}</button>
                        </div>
                        <div id="comments-${d.id}" class="hidden" style="margin-top:10px">
                            ${(p.comments || []).map(c => `<div class="comment-box"><span class="comment-user">${c.user}:</span> ${c.text}</div>`).join('')}
                            <div style="display:flex; margin-top:5px; gap:5px">
                                <input id="c-input-${d.id}" style="flex:1; border:1px solid #eee; border-radius:5px; padding:5px" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚...">
                                <button onclick="addComment('${d.id}')" style="background:var(--primary); color:white; border:none; padding:5px 10px; border-radius:5px">Ù†Ø´Ø±</button>
                            </div>
                        </div>
                    `;
                    list.appendChild(div);
                });
            });
        }

        window.likePost = async (id, liked) => {
            await updateDoc(doc(db, "posts", id), { likes: liked ? arrayRemove(user.uid) : arrayUnion(user.uid) });
        };

        window.openComments = (id) => document.getElementById('comments-' + id).classList.toggle('hidden');

        window.addComment = async (id) => {
            const input = document.getElementById('c-input-' + id);
            if(!input.value.trim()) return;
            const uSnap = await getDoc(doc(db, "users", user.uid));
            await updateDoc(doc(db, "posts", id), {
                comments: arrayUnion({ user: uSnap.data().name, text: input.value })
            });
            input.value = "";
        };

        window.deletePost = async (id) => { if(confirm("Ø­Ø°ÙØŸ")) await deleteDoc(doc(db, "posts", id)); };

        window.searchUsers = async () => {
            const term = document.getElementById('search-input').value.toLowerCase();
            const resultsBox = document.getElementById('search-results');
            if(!term) { resultsBox.innerHTML = ""; return; }
            
            const q = query(collection(db, "users"));
            const snap = await getDocs(q);
            resultsBox.innerHTML = "";
            snap.forEach(d => {
                const u = d.data();
                if(u.username.includes(term)) {
                    resultsBox.innerHTML += `
                        <div class="post-card" style="display:flex; align-items:center; cursor:pointer" onclick="alert('Ù…Ù„Ù @${u.username}')">
                            <div class="avatar">${u.name[0]}</div>
                            <div>
                                <b>${u.name}</b><br>
                                <span style="color:var(--secondary)">@${u.username}</span>
                            </div>
                        </div>
                    `;
                }
            });
        }
    </script>
</body>
</html>

