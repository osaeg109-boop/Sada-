<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>  Sada   </title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6c5ce7;
            --secondary: #a29bfe;
            --accent: #fd79a8;
            --bg: #f4f7f6;
            --white: #ffffff;
            --text: #2d3436;
            --shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; background: var(--bg); color: var(--text); padding-bottom: 75px; overflow-x: hidden; }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        header { 
            background: var(--white); padding: 10px 20px; position: sticky; top: 0; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 15px rgba(0,0,0,0.04);
        }
        .logo { font-size: 28px; font-weight: 900; color: var(--primary); letter-spacing: -1px; }
        .header-icons { display: flex; gap: 15px; font-size: 22px; cursor: pointer; position: relative; }
        .noti-badge { position: absolute; top: -5px; right: -5px; background: var(--accent); color: white; font-size: 10px; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        /* Ø§Ù„Ù‚ØµØµ - Stories */
        .stories-bar { display: flex; gap: 12px; padding: 15px; overflow-x: auto; background: var(--white); margin-bottom: 10px; scrollbar-width: none; }
        .stories-bar::-webkit-scrollbar { display: none; }
        .story-item { flex-shrink: 0; text-align: center; width: 65px; }
        .story-circle { width: 60px; height: 60px; border-radius: 50%; border: 3px solid var(--primary); padding: 2px; position: relative; }
        .story-circle img, .story-circle .placeholder { width: 100%; height: 100%; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .story-name { font-size: 10px; margin-top: 5px; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª */
        .view { display: none; padding: 15px; max-width: 600px; margin: 0 auto; }
        .view.active { display: block; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª */
        .post-card { background: var(--white); border-radius: 20px; padding: 18px; margin-bottom: 15px; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.01); position: relative; }
        .post-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .avatar { width: 45px; height: 45px; border-radius: 15px; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 18px; }
        .user-meta .name { font-weight: 800; font-size: 15px; }
        .user-meta .username { font-size: 12px; color: var(--secondary); font-weight: 600; }
        .post-img { width: 100%; border-radius: 15px; margin: 10px 0; max-height: 400px; object-fit: cover; background: #f9f9f9; }
        
        /* Ø§Ù„ØªÙØ§Ø¹Ù„ */
        .post-actions { display: flex; gap: 10px; border-top: 1px solid #f1f2f6; padding-top: 12px; margin-top: 10px; }
        .act-btn { flex: 1; border: none; background: #f8f9fa; padding: 10px; border-radius: 12px; color: #555; font-weight: 700; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s; cursor: pointer; }
        .act-btn.liked { color: #e84393; background: #fff0f6; }

        /* Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© */
        .chat-list-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: white; border-radius: 15px; margin-bottom: 10px; cursor: pointer; box-shadow: var(--shadow); }
        .chat-view-header { position: sticky; top: 0; background: var(--white); padding: 15px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #eee; z-index: 10; }
        #chat-messages { height: 60vh; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg-bubble { max-width: 80%; padding: 12px; border-radius: 15px; font-size: 14px; line-height: 1.4; position: relative; }
        .msg-sent { background: var(--primary); color: white; align-self: flex-end; border-bottom-left-radius: 2px; }
        .msg-received { background: white; align-self: flex-start; border-bottom-right-radius: 2px; border: 1px solid #eee; }

        /* Ø§Ù„Ù†Ø§Ù Ø¨Ø§Ø± */
        nav { position: fixed; bottom: 0; width: 100%; background: var(--white); height: 70px; display: flex; border-top: 1px solid #eee; z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #b2bec3; cursor: pointer; position: relative; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 24px; }
        .nav-item span { font-size: 10px; font-weight: 800; margin-top: 2px; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #auth-view { position: fixed; inset: 0; background: white; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
        .input-group { width: 100%; max-width: 380px; margin-bottom: 15px; }
        .input-group input { width: 100%; padding: 15px; border-radius: 15px; border: 2px solid #f1f2f6; font-size: 16px; outline: none; }
        .btn-grad { width: 100%; max-width: 380px; padding: 16px; border-radius: 15px; border: none; background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white; font-weight: 800; font-size: 18px; cursor: pointer; box-shadow: 0 10px 20px rgba(108, 92, 231, 0.2); }

        .hidden { display: none !important; }
        .record-btn { background: #ff7675; border: none; color: white; padding: 8px 15px; border-radius: 20px; font-size: 12px; cursor: pointer; }
    </style>
</head>
<body>

    <!-- Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="auth-view">
        <h1 class="logo" style="font-size: 60px; margin-bottom: 10px;">ØµØ¯Ù‰</h1>
        <p style="color: #636e72; margin-bottom: 40px; font-weight: bold;">ØªÙˆØ§ØµÙ„ Ø¨Ù…Ø³ØªÙˆÙ‰ Ø¢Ø®Ø±</p>
        <div id="auth-error" style="color:red; margin-bottom: 15px; font-size: 13px;"></div>
        
        <div id="reg-box" class="hidden" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
            <div class="input-group"><input type="text" id="reg-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„"></div>
            <div class="input-group"><input type="text" id="reg-user" placeholder="Ø§Ù„ÙŠÙˆØ²Ø± Ù†ÙŠÙ… (Ù…Ø«Ø§Ù„: sada_user)"></div>
        </div>
        
        <div class="input-group"><input type="email" id="auth-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"></div>
        <div class="input-group"><input type="password" id="auth-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"></div>
        
        <button class="btn-grad" onclick="handleAuth()" id="auth-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        <button style="background:none; border:none; color:var(--primary); margin-top:20px; font-weight:800; cursor:pointer;" onclick="toggleAuth()" id="toggle-btn">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù†</button>
    </div>

    <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
    <header id="app-header" class="hidden">
        <div class="logo">Sada</div>
        <div class="header-icons">
            <span onclick="navTo('noti')">ğŸ”” <div class="noti-badge" id="noti-count">0</div></span>
            <span onclick="navTo('chat')">ğŸ’¬</span>
        </div>
    </header>

    <div id="app-body" class="hidden">
        
        <!-- Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <div id="home-view" class="view active">
            <!-- Ø§Ù„Ù‚ØµØµ -->
            <div class="stories-bar" id="stories-list">
                <div class="story-item" onclick="alert('Ø±ÙØ¹ Ù‚ØµØ© Ù‚Ø±ÙŠØ¨Ø§Ù‹')">
                    <div class="story-circle" style="border-style: dashed; border-color: #ccc;">
                        <div class="placeholder">+</div>
                    </div>
                    <div class="story-name">Ù‚ØµØªÙƒ</div>
                </div>
            </div>
            
            <div id="posts-feed"></div>
        </div>

        <!-- Ø§Ù„Ø¨Ø­Ø« -->
        <div id="search-view" class="view">
            <div class="input-group" style="max-width: none;">
                <input type="text" id="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ØµØ¯Ù‚Ø§Ø¡..." oninput="searchUsers()">
            </div>
            <div id="search-results"></div>
        </div>

        <!-- Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
        <div id="chat-view" class="view">
            <div id="chat-list"></div>
            <!-- Ù†Ø§ÙØ°Ø© Ù…Ø­Ø§Ø¯Ø«Ø© Ø®Ø§ØµØ© (Ø³ØªØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±) -->
            <div id="private-chat" class="hidden" style="position:fixed; inset:0; background:var(--bg); z-index:2000;">
                <div class="chat-view-header">
                    <button onclick="document.getElementById('private-chat').classList.add('hidden')" style="background:none; border:none; font-size:20px; cursor:pointer;">â†</button>
                    <div class="avatar" id="chat-avatar">ØŸ</div>
                    <div id="chat-target-name" style="font-weight:900;">...</div>
                </div>
                <div id="chat-messages"></div>
                <div style="background:white; padding:15px; display:flex; gap:10px; align-items:center;">
                    <button class="record-btn" onclick="sendVoiceMsg()">ğŸ™ï¸</button>
                    <input type="text" id="msg-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." style="flex:1; border:1px solid #eee; padding:10px; border-radius:15px;">
                    <button onclick="sendMsg()" style="background:var(--primary); color:white; border:none; padding:10px 15px; border-radius:15px;">Ø¥Ø±Ø³Ø§Ù„</button>
                </div>
            </div>
        </div>

        <!-- Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø´ÙˆØ± -->
        <div id="add-view" class="view">
            <div class="post-card">
                <h3>Ù†Ø´Ø± Ø¬Ø¯ÙŠØ¯</h3>
                <textarea id="post-text" style="width:100%; height:150px; border:none; background:#f8f9fa; border-radius:15px; padding:15px; font-size:16px; outline:none; resize:none;" placeholder="Ø¨Ù…Ø§Ø°Ø§ ØªØ´Ø¹Ø± Ø§Ù„ÙŠÙˆÙ…ØŸ"></textarea>
                <input type="text" id="post-img-url" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="width:100%; padding:10px; margin-top:10px; border-radius:10px; border:1px solid #eee;">
                <button class="btn-grad" style="margin-top:15px; width:100%; max-width:none;" onclick="createPost()">Ù†Ø´Ø± ÙÙŠ ØµØ¯Ù‰</button>
            </div>
        </div>

        <!-- Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
        <div id="noti-view" class="view">
            <h3>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
            <div id="notifications-list"></div>
        </div>

        <!-- Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
        <div id="profile-view" class="view">
            <div class="post-card" style="text-align: center; padding: 40px 20px;">
                <div class="avatar" style="width:100px; height:100px; margin:0 auto 15px; font-size:40px;" id="p-avatar">ØŸ</div>
                <h2 id="p-name" style="margin:0;">...</h2>
                <div id="p-user" style="color:var(--secondary); font-weight:800; margin-bottom:15px;">@username</div>
                
                <div style="display:flex; justify-content:center; gap:20px; margin-bottom:25px;">
                    <div><b id="p-following">0</b><br><small>Ù…ØªØ§Ø¨Ø¹Ø©</small></div>
                    <div><b id="p-followers">0</b><br><small>Ù…ØªØ§Ø¨Ø¹</small></div>
                </div>

                <div style="display:flex; flex-direction:column; gap:10px;">
                    <button class="btn-grad" style="background:#f1f2f6; color:#333; box-shadow:none;" onclick="alert('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù‚Ø±ÙŠØ¨Ø§Ù‹')">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</button>
                    <button class="btn-grad" style="background:var(--accent); box-shadow:none;" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Ø§Ù„Ù†Ø§Ù Ø¨Ø§Ø± -->
    <nav id="app-nav" class="hidden">
        <div class="nav-item active" onclick="navTo('home', this)"><i>ğŸ </i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
        <div class="nav-item" onclick="navTo('search', this)"><i>ğŸ”</i><span>Ø§ÙƒØªØ´Ù</span></div>
        <div class="nav-item" onclick="navTo('add', this)"><i>â•</i><span>Ù†Ø´Ø±</span></div>
        <div class="nav-item" onclick="navTo('profile', this)"><i>ğŸ‘¤</i><span>Ø­Ø³Ø§Ø¨ÙŠ</span></div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, serverTimestamp, doc, getDoc, setDoc, deleteDoc, updateDoc, arrayUnion, arrayRemove, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAhg6oTG1EJ44ST1zkkeYvKpfLMD2JDV3M",
            authDomain: "fir-c3e88.firebaseapp.com",
            projectId: "fir-c3e88",
            storageBucket: "fir-c3e88.firebasestorage.app",
            messagingSenderId: "202130175288",
            appId: "1:202130175288:web:0d7ad99c3c828501b4fdcd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let user = null;
        let userData = null;
        let isLogin = true;
        let chatTarget = null;

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ---
        window.toggleAuth = () => {
            isLogin = !isLogin;
            document.getElementById('reg-box').classList.toggle('hidden');
            document.getElementById('auth-btn').innerText = isLogin ? "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„" : "Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù†";
            document.getElementById('toggle-btn').innerText = isLogin ? "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù†" : "Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ";
        };

        window.handleAuth = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const name = document.getElementById('reg-name').value;
            const username = document.getElementById('reg-user').value.trim().toLowerCase();
            const err = document.getElementById('auth-error');

            try {
                if(isLogin) {
                    await signInWithEmailAndPassword(auth, email, pass);
                } else {
                    if(!username || !name) throw new Error("ÙŠØ¬Ø¨ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§Ù…Ù„Ø©");
                    const q = query(collection(db, "users"), where("username", "==", username));
                    const check = await getDocs(q);
                    if(!check.empty) throw new Error("Ø§Ù„ÙŠÙˆØ²Ø± Ù†ÙŠÙ… Ù…Ø£Ø®ÙˆØ°");

                    const res = await createUserWithEmailAndPassword(auth, email, pass);
                    await setDoc(doc(db, "users", res.user.uid), {
                        name, username, email, uid: res.user.uid,
                        followers: [], following: [], privacy: 'public'
                    });
                }
            } catch(e) { err.innerText = e.message; }
        };

        onAuthStateChanged(auth, async (u) => {
            if(u) {
                user = u;
                document.getElementById('auth-view').classList.add('hidden');
                document.querySelectorAll('.hidden').forEach(el => el.classList.remove('hidden'));
                
                const snap = await getDoc(doc(db, "users", u.uid));
                userData = snap.data();
                document.getElementById('p-name').innerText = userData.name;
                document.getElementById('p-user').innerText = "@" + userData.username;
                document.getElementById('p-avatar').innerText = userData.name[0];
                document.getElementById('p-followers').innerText = userData.followers?.length || 0;
                document.getElementById('p-following').innerText = userData.following?.length || 0;

                loadPosts();
                loadStories();
                loadNotifications();
                loadChatList();
            }
        });

        window.logout = () => signOut(auth).then(() => location.reload());

        // --- Ø§Ù„ØªÙ†Ù‚Ù„ ---
        window.navTo = (id, el) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id + '-view').classList.add('active');
            if(el) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                el.classList.add('active');
            }
        };

        // --- Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª ---
        window.createPost = async () => {
            const txt = document.getElementById('post-text').value;
            const img = document.getElementById('post-img-url').value;
            if(!txt.trim()) return;
            await addDoc(collection(db, "posts"), {
                text: txt, img, uid: user.uid, author: userData.name, username: userData.username,
                likes: [], comments: [], at: serverTimestamp()
            });
            document.getElementById('post-text').value = "";
            document.getElementById('post-img-url').value = "";
            navTo('home', document.querySelector('.nav-item'));
        };

        function loadPosts() {
            const q = query(collection(db, "posts"), orderBy("at", "desc"));
            onSnapshot(q, (snap) => {
                const feed = document.getElementById('posts-feed');
                feed.innerHTML = "";
                snap.forEach(d => {
                    const p = d.data();
                    const isLiked = p.likes?.includes(user.uid);
                    feed.innerHTML += `
                        <div class="post-card">
                            <div class="post-header">
                                <div class="avatar">${p.author[0]}</div>
                                <div class="user-meta">
                                    <div class="name">${p.author}</div>
                                    <div class="username">@${p.username}</div>
                                </div>
                                ${p.uid !== user.uid ? `<button onclick="toggleFollow('${p.uid}')" style="margin-right:auto; border:none; color:var(--primary); background:none; font-weight:bold;">Ù…ØªØ§Ø¨Ø¹Ø©</button>` : ''}
                            </div>
                            <div class="post-content">${p.text}</div>
                            ${p.img ? `<img src="${p.img}" class="post-img" onerror="this.style.display='none'">` : ''}
                            <div class="post-actions">
                                <button class="act-btn ${isLiked ? 'liked' : ''}" onclick="likePost('${d.id}', ${isLiked})">â¤ï¸ ${p.likes?.length || 0}</button>
                                <button class="act-btn" onclick="alert('Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±')">ğŸ’¬ ${p.comments?.length || 0}</button>
                                <button class="act-btn" onclick="openPrivateChat('${p.uid}', '${p.author}')">âœ‰ï¸</button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        window.likePost = async (id, liked) => {
            await updateDoc(doc(db, "posts", id), { likes: liked ? arrayRemove(user.uid) : arrayUnion(user.uid) });
        };

        // --- Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ---
        window.toggleFollow = async (targetId) => {
            await updateDoc(doc(db, "users", user.uid), { following: arrayUnion(targetId) });
            await updateDoc(doc(db, "users", targetId), { followers: arrayUnion(user.uid) });
            alert("ØªÙ…Øª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©!");
        };

        // --- Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ---
        window.openPrivateChat = (uid, name) => {
            chatTarget = { uid, name };
            document.getElementById('chat-target-name').innerText = name;
            document.getElementById('chat-avatar').innerText = name[0];
            document.getElementById('private-chat').classList.remove('hidden');
            loadMessages(uid);
        };

        window.sendMsg = async () => {
            const txt = document.getElementById('msg-input').value;
            if(!txt.trim()) return;
            const chatId = [user.uid, chatTarget.uid].sort().join('_');
            await addDoc(collection(db, "messages"), {
                chatId, text: txt, from: user.uid, to: chatTarget.uid, at: serverTimestamp()
            });
            document.getElementById('msg-input').value = "";
        };

        function loadMessages(targetId) {
            const chatId = [user.uid, targetId].sort().join('_');
            const q = query(collection(db, "messages"), where("chatId", "==", chatId), orderBy("at", "asc"));
            onSnapshot(q, (snap) => {
                const box = document.getElementById('chat-messages');
                box.innerHTML = "";
                snap.forEach(d => {
                    const m = d.data();
                    const type = m.from === user.uid ? 'sent' : 'received';
                    box.innerHTML += `<div class="msg-bubble msg-${type}">${m.text}</div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ
        window.sendVoiceMsg = () => {
            alert("Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„... (Ù‡Ø°Ù‡ Ù…ÙŠØ²Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©ØŒ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù†Øµ Ù…Ø­Ø§ÙƒÙ‰)");
            document.getElementById('msg-input').value = "ğŸ”Š Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© (0:05)";
            window.sendMsg();
        };

        // --- Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ---
        function loadNotifications() {
            const q = query(collection(db, "notifications"), where("to", "==", user.uid), orderBy("at", "desc"));
            onSnapshot(q, (snap) => {
                document.getElementById('noti-count').innerText = snap.size;
                const list = document.getElementById('notifications-list');
                list.innerHTML = snap.empty ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª" : "";
                snap.forEach(d => {
                    const n = d.data();
                    list.innerHTML += `<div class="post-card">${n.text}</div>`;
                });
            });
        }

        // --- Ø§Ù„Ø¨Ø­Ø« ---
        window.searchUsers = async () => {
            const term = document.getElementById('search-input').value.toLowerCase();
            if(!term) return;
            const snap = await getDocs(collection(db, "users"));
            const res = document.getElementById('search-results');
            res.innerHTML = "";
            snap.forEach(d => {
                const u = d.data();
                if(u.username.includes(term) && u.uid !== user.uid) {
                    res.innerHTML += `
                        <div class="chat-list-item" onclick="openPrivateChat('${u.uid}', '${u.name}')">
                            <div class="avatar">${u.name[0]}</div>
                            <div><b>${u.name}</b><br><small>@${u.username}</small></div>
                        </div>
                    `;
                }
            });
        };

        function loadStories() {
            // Ù…Ø­Ø§ÙƒØ§Ø© Ù‚ØµØµ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†
            const list = document.getElementById('stories-list');
            const names = ["Ø£Ø­Ù…Ø¯", "Ø³Ø§Ø±Ø©", "Ø®Ø§Ù„Ø¯", "Ù„ÙŠÙ„Ù‰"];
            names.forEach(n => {
                list.innerHTML += `
                    <div class="story-item" onclick="alert('Ù‚ØµØ© ${n}')">
                        <div class="story-circle"><div class="placeholder">${n[0]}</div></div>
                        <div class="story-name">${n}</div>
                    </div>
                `;
            });
        }

        function loadChatList() {
            // Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† ØªÙˆØ§ØµÙ„Øª Ù…Ø¹Ù‡Ù…
            document.getElementById('chat-list').innerHTML = "<p style='text-align:center; color:gray'>Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø©</p>";
        }

    </script>
</body>
</html>

